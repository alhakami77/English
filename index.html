<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©: Ø±Ø­Ù„Ø© Ø§Ù„ØªØ£Ø³ÙŠØ³- Ù‡ÙŠ Ù…Ù†ØµØ© ØªØ§Ø³ÙŠØ³ ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨ÙƒØ± Ø¬Ø¯Ø§Ù‹ Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ù„Ø¹Ø© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ùˆ ØªØ´Ù…Ù„ ØªØ¯Ø±ÙŠØ¨Ø§Øª Ùˆ Ø§Ø®ØªØ¨Ø§Ø±Øª ØªÙØ§Ø¹Ù„ÙŠØ© Ù…Ø®ØªÙ„ÙØ©</title>
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap');
        
        :root {
            --primary-color: #4f46e5; /* Indigo */
            --secondary-color: #10b981; /* Emerald */
            --correct-color: #22c55e; /* Green */
            --incorrect-color: #ef4444; /* Red */
            --background-color: #f3f4f6; /* Gray 100 */
            --light-grey: #e5e7eb;
            --dark-text: #1f2937;
            --white: #ffffff;
            --locked-color: #9ca3af;
            --star-color: #f59e0b; /* Amber */
            --gold-color: #ffc700;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Tajawal', sans-serif; text-align: center; margin: 0;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; color: var(--dark-text); background-color: var(--background-color);
            padding: 20px 0; overflow-x: hidden;
            touch-action: manipulation;
        }

        #app-container {
            max-width: 900px; width: 95%; background: var(--white); padding: 25px;
            border-radius: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            position: relative; transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s ease-in-out; z-index: 10;
        }
        
        .sidebar-open #app-container { transform: translateX(-280px); }

        #sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); z-index: 150;
            opacity: 0; visibility: hidden; transition: opacity 0.4s ease-in-out;
        }
        .sidebar-open #sidebar-overlay { opacity: 1; visibility: visible; }
        
        #sidebar {
            position: fixed; top: 0; right: 0; width: 280px; height: 100%;
            background-color: var(--dark-text); color: var(--white);
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            z-index: 200; padding: 20px; box-shadow: -10px 0 20px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; text-align: right;
            overflow-y: auto;
        }
        .sidebar-open #sidebar { transform: translateX(0); }
        #sidebar h3 { color: var(--secondary-color); border-bottom: 1px solid #4a5568; padding-bottom: 10px; margin-top: 15px; margin-bottom: 10px;}
        #sidebar h3:first-of-type { margin-top: 0; }
        #sidebar .sidebar-section { margin-bottom: 15px; }

        .screen { display: none; }
        .screen.active { display: block; animation: screen-enter 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        @keyframes screen-enter { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        h1, h2 { font-weight: 900; color: var(--primary-color); }
        h2 { color: var(--secondary-color); border-bottom: 2px solid var(--light-grey); padding-bottom: 10px; margin-bottom: 25px; }
        
        button {
            background-color: var(--primary-color); color: white; padding: 14px 32px; border: none;
            border-radius: 50px; cursor: pointer; font-size: 1.1rem; font-weight: bold;
            transition: all 0.2s ease; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2);
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 7px 20px rgba(79, 70, 229, 0.3); }
        button:disabled { background-color: var(--locked-color); cursor: not-allowed; box-shadow: none; transform: none; }
        
        .sidebar-btn { width: 100%; justify-content: flex-start; background: none; border: 1px solid #4a5568; padding: 12px 15px; border-radius: 10px; margin-bottom: 10px; text-align: right; }
        .sidebar-btn:hover { background: #4a5568; }

        .input-group input, .input-group select { width: 80%; max-width: 400px; padding: 12px; border-radius: 10px; border: 2px solid var(--light-grey); font-size: 1.1rem; font-family: 'Tajawal', sans-serif; text-align: center; transition: all 0.3s; background-color: white; color: var(--dark-text);}
        .input-group select { text-align-last: center; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); }
        
        #top-bar { display: flex; justify-content: space-between; align-items: center; position: absolute; top: 15px; left: 15px; right: 15px; z-index: 100; }
        #top-bar-left { display: flex; gap: 10px; align-items: center; }
        .setting-btn { background: var(--white); color: var(--dark-text); border: 1px solid var(--light-grey); border-radius: 50%; width: 40px; height: 40px; font-size: 18px; cursor: pointer; padding: 0; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .toggle-switch { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; }
        .toggle-switch label { font-size: 1.1rem; }
        .toggle-switch .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .toggle-switch .switch input { opacity: 0; width: 0; height: 0; }
        .toggle-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
        .toggle-switch .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        .toggle-switch input:checked + .slider { background-color: var(--secondary-color); }
        .toggle-switch input:checked + .slider:before { transform: translateX(22px); }

        #level-path-container { max-height: 55vh; overflow-y: auto; padding: 10px; border: 1px solid var(--light-grey); border-radius: 15px; margin-top: 20px; }
        #level-path { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; }
        .level-node { background-color: var(--light-grey); padding: 15px; border-radius: 15px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100px; position: relative; }
        .level-node:not(.locked):hover { transform: translateY(-5px); border-color: var(--secondary-color); }
        .level-node.locked { background-color: #f1f1f1; color: var(--locked-color); cursor: not-allowed; }
        .level-node.completed { background: linear-gradient(135deg, var(--star-color), #fcd34d); color: var(--dark-text); border-color: var(--star-color); }
        .level-node.current { animation: pulse 2s infinite; border-color: var(--primary-color); }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(79, 70, 229, 0); } 100% { box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); } }

        #game-screen-layout { position: relative; }
        #level-progress-tracker { position: absolute; top: 0; right: -25px; display: flex; flex-direction: column; gap: 8px; }
        .star { font-size: 1.8rem; color: var(--light-grey); transition: all 0.3s ease; }
        .star.filled { color: var(--star-color); transform: scale(1.2); }

        .correct-input { border-color: var(--correct-color) !important; background-color: #f0fff4; }
        .incorrect-input { border-color: var(--incorrect-color) !important; background-color: #fff5f5; animation: shake 0.5s; }
        @keyframes shake { 10%, 90% { transform: translateX(-3px); } 20%, 80% { transform: translateX(3px); } 30%, 50%, 70% { transform: translateX(-5px); } 40%, 60% { transform: translateX(5px); } }
        
        .car-card model-viewer {
            width: 100%; height: 180px; min-height: 180px;
            border-radius: 8px;
            background-color: #e9e9e9;
            border: 1px solid var(--light-grey);
            cursor: grab;
        }
        .model-error { display: flex; justify-content: center; align-items: center; height: 100%; color: var(--dark-text); font-weight: bold; }

        
        #study-corner-screen .study-section, #achievements-screen .study-section, #stats-screen .study-section { margin-bottom: 30px; text-align: right; }
        #study-corner-screen .study-section h3, #achievements-screen .study-section h3, #stats-screen .study-section h3 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; display: inline-block; }
        .study-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .study-item { background: #f9fafb; padding: 15px; border-radius: 10px; border: 1px solid var(--light-grey); text-align: center; }
        .study-item .en { font-size: 1.5rem; font-weight: bold; color: var(--dark-text); direction: ltr; }
        .study-item .ar { font-size: 1.1rem; color: #6b7280; }
        .speak-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary-color); padding: 5px; box-shadow: none; }
        .generic-item { display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 8px; text-align: right; }
        .generic-item .en { font-weight: bold; font-size: 1.2rem; }
        .generic-item .example { font-size: 0.9rem; color: #6b7280; margin-top: 4px; direction: ltr; text-align: left; }
        
        .achievement-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .achievement-card { padding: 20px; border-radius: 15px; border: 1px solid var(--light-grey); transition: all 0.3s; }
        .achievement-card.unlocked { background-color: #f0fff4; border-color: var(--secondary-color); }
        .achievement-card.locked { background-color: #fafafa; opacity: 0.6; }
        .achievement-icon { font-size: 3rem; }
        .achievement-title { font-weight: bold; margin-top: 10px; }
        .achievement-desc { font-size: 0.9rem; color: #6b7280; }
        
        #mic-btn { font-size: 4rem; width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 20px auto; }
        #mic-btn.recording { background-color: var(--incorrect-color); animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        #matching-game-area { display: flex; justify-content: space-around; gap: 20px; margin-top: 20px; }
        .matching-column { flex: 1; display: flex; flex-direction: column; gap: 10px; min-width: 0; }

        .match-item { padding: 15px 20px; border: 2px solid var(--light-grey); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; font-size: 1.3rem; font-weight: bold; display: flex; align-items: center; justify-content: center; min-height: 70px; }
        .match-item:hover { background-color: #f3f4f6; border-color: var(--secondary-color); }
        .match-item.selected { background-color: var(--primary-color); color: var(--white); border-color: var(--primary-color); transform: scale(1.05); }
        .match-item.matched { background-color: var(--correct-color) !important; color: var(--white) !important; border-color: var(--correct-color) !important; cursor: default; opacity: 0.7; }
        .match-item.incorrect-flash { animation: shake 0.5s; background-color: var(--incorrect-color) !important; border-color: var(--incorrect-color) !important; color: var(--white) !important; }
        .match-item.audio-item { font-size: 3rem; }

        .profile-and-challenge-container { display: flex; gap: 15px; margin-bottom: 20px; }
        #main-screen-profile-info, #daily-challenge-container {
            flex: 1; 
            background: #f9fafb; padding: 15px; border-radius: 12px; text-align: right; 
            min-width: 0; 
        }
        #daily-challenge-container { background: linear-gradient(135deg, var(--primary-color), #6d28d9); color: white; text-align: center; }

        #daily-challenge-container h3 { color: white; border-bottom: 1px solid rgba(255,255,255,0.5); padding-bottom: 8px; margin-top: 0; }
        #daily-challenge-progress-bar-container { background: rgba(0,0,0,0.2); border-radius: 20px; margin-top: 10px; }
        #daily-challenge-progress-bar { height: 10px; background: var(--gold-color); width: 0%; border-radius: 20px; transition: width 0.5s ease; }
        .coin-animation { position: fixed; font-size: 2rem; z-index: 1000; color: var(--gold-color); transition: all 1s cubic-bezier(0.5, -0.5, 1, 1); }

        .stat-card { background: #f9fafb; padding: 20px; border-radius: 12px; text-align: center; border: 1px solid var(--light-grey); }
        .stat-value { font-size: 2.5rem; font-weight: 900; color: var(--primary-color); }
        .stat-label { font-size: 1.1rem; color: #6b7280; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }

        #phrase-builder-area { display: flex; flex-direction: column; gap: 15px; }
        .drop-zone {
            min-height: 70px;
            border-radius: 10px;
            padding: 10px;
            transition: background-color 0.3s, border-color 0.3s;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-content: flex-start;
        }
        #phrase-builder-answer-area {
            border: 2px dashed var(--primary-color);
            direction: ltr;
            font-size: 1.5rem;
        }
        #phrase-builder-word-bank {
            border: 2px dashed var(--light-grey);
            margin-top: 10px;
        }
        .drop-zone.drag-over {
            border-color: var(--secondary-color) !important;
            background-color: #f0fbf8;
        }
        .word-chip {
            padding: 10px 20px;
            background: #fdfdfe;
            border: 1px solid var(--light-grey);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 1.2rem;
            user-select: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: inline-flex;
            align-items: center;
        }
        
        .word-chip[draggable="true"] { cursor: grab; }
        .word-chip[draggable="true"]:active { cursor: grabbing; }

        .word-chip.dragging {
            opacity: 0.8;
            transform: scale(1.08);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .word-chip.correct-flash {
            animation: flash-green 0.5s ease-out;
        }
        @keyframes flash-green {
            from, to { background-color: var(--correct-color); color: white; }
            50% { background-color: var(--light-grey); color: var(--dark-text); }
        }
        #phrase-builder-feedback.correct-feedback { animation: bounceIn 0.5s; }
        #phrase-builder-feedback.incorrect-feedback { animation: shake 0.5s; }
        @keyframes bounceIn { 0%, 20%, 40%, 60%, 80%, 100% { animation-timing-function: cubic-bezier(0.215, 0.610, 0.355, 1.000); } 0% { opacity: 0; transform: scale3d(.3, .3, .3); } 20% { transform: scale3d(1.1, 1.1, 1.1); } 40% { transform: scale3d(.9, .9, .9); } 60% { opacity: 1; transform: scale3d(1.03, 1.03, 1.03); } 80% { transform: scale3d(.97, .97, .97); } 100% { opacity: 1; transform: scale3d(1, 1, 1); } }
    </style>
</head>
<body id="body-container">

    <div id="sidebar-overlay"></div>

    <div id="sidebar">
        <div class="sidebar-section">
            <h3>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
            <button id="home-btn-sidebar" class="sidebar-btn">ğŸ  Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>
        <div class="sidebar-section">
            <h3>ğŸš€ ØªØ¯Ø±ÙŠØ¨ ÙˆÙ…Ø°Ø§ÙƒØ±Ø©</h3>
            <button id="study-corner-btn-sidebar" class="sidebar-btn">ğŸ“š Ø±ÙƒÙ† Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</button>
            <button id="achievements-btn-sidebar" class="sidebar-btn">ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</button>
            <button id="stats-btn-sidebar" class="sidebar-btn">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</button>
            <button id="garage-btn-sidebar" class="sidebar-btn">ğŸš— Ø§Ù„Ø¬Ø±Ø§Ø¬</button>
        </div>
        <div class="sidebar-section">
             <h3>ğŸ¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØªØ­Ø¯ÙŠØ§Øª</h3>
            <button id="start-quick-test-btn-sidebar" class="sidebar-btn">âš¡ï¸ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹</button>
            <button id="start-cumulative-test-btn-sidebar" class="sidebar-btn">ğŸ§  Ø§Ø®ØªØ¨Ø§Ø± ØªØ±Ø§ÙƒÙ…ÙŠ</button>
            <button id="speaking-test-btn-sidebar" class="sidebar-btn">ğŸ™ï¸ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØ§Ù„ØªØ­Ø¯Ø«</button>
            <button id="matching-test-btn-sidebar" class="sidebar-btn">ğŸ§© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</button>
            <button id="phrase-builder-btn-sidebar" class="sidebar-btn">ğŸ“ Ø¨Ù†Ù‘Ø§Ø¡ Ø§Ù„Ø¬Ù…Ù„</button>
        </div>
        <div class="sidebar-section">
            <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
            <div class="toggle-switch">
                <label for="strict-mode-checkbox">ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØªÙ‚Ø§Ù†</label>
                <div class="switch"><input type="checkbox" id="strict-mode-checkbox"><span class="slider"></span></div>
            </div>
             <div class="toggle-switch">
                <label for="sfx-checkbox">Ø§Ù„Ù…Ø¤Ø«Ø±Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</label>
                <div class="switch"><input type="checkbox" id="sfx-checkbox" checked><span class="slider"></span></div>
            </div>
            <div class="toggle-switch">
                <label for="tts-checkbox">Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</label>
                <div class="switch"><input type="checkbox" id="tts-checkbox" checked><span class="slider"></span></div>
            </div>
            <div class="toggle-switch">
                <label for="phrase-builder-mode-checkbox">Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù…Ù„ (Ø¨Ø§Ù„Ø³Ø­Ø¨)</label>
                <div class="switch"><input type="checkbox" id="phrase-builder-mode-checkbox"><span class="slider"></span></div>
            </div>
            <p style="font-size: 0.8rem; color: var(--light-grey); padding: 0 5px;">ÙØ¹Ù‘Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Ù‚Ø±.</p>
            <div class="input-group" style="margin-top: 15px;">
                <label for="voice-select" style="font-size: 1.1rem; display: block; margin-bottom: 5px;">Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØª</label>
                <select id="voice-select"></select>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div id="top-bar" style="display: none;">
            <div id="top-bar-left">
                 <button id="sidebar-toggle-btn" class="setting-btn" title="ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©">â˜°</button>
                 <div id="player-stats" style="position: relative;">
                     <span id="player-coins">ğŸ’° 0</span>
                 </div>
            </div>
            <div id="avatar-container">ğŸ¤”</div>
        </div>

        <div id="login-screen" class="screen">
            <h1>Ø§Ù„Ù…ØºØ§Ù…Ø±Ø© Ø§Ù„ØªØ£Ø³ÙŠØ³ÙŠØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© v9.0</h1>
            <p style="font-size: 1.2rem; margin-top:20px;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ø¨Ø¯Ø¡ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ù…Ø±Ø­ ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹!</p>
            <div class="login-options" style="margin-top: 40px; display: flex; flex-direction: column; align-items: center; gap: 15px;">
                <button id="google-login-btn" style="width: 80%; max-width: 300px;">
                    <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.75 8.36,4.73 12.19,4.73C14.03,4.73 15.6,5.36 16.81,6.45L19.08,4.18C17.24,2.56 14.86,1.5 12.19,1.5C7.03,1.5 3,5.5 3,12C3,18.5 7.03,22.5 12.19,22.5C17.6,22.5 21.7,18.5 21.7,12.33C21.7,11.83 21.5,11.45 21.35,11.1Z" /></svg>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬ÙˆØ¬Ù„
                </button>
                <div class="or-divider" style="color: var(--locked-color); margin: 15px 0;">Ø£Ùˆ</div>
                 <div class="input-group">
                    <input type="text" id="player-name-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©" maxlength="20">
                </div>
                <button id="start-learning-btn">ğŸš€ Ù‡ÙŠØ§ Ù†Ù†Ø·Ù„Ù‚!</button>
            </div>
             <p style="margin-top: 30px; font-size: 0.8rem; color: #666;">
                Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‡Ùˆ Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­ ÙÙ‚Ø·.
            </p>
        </div>

        <div id="level-select-screen" class="screen">
            <h2 id="player-greeting"></h2>
            <div class="profile-and-challenge-container">
                <div id="main-screen-profile-info"></div>
                <div id="daily-challenge-container"></div>
            </div>
            <h3>Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ¹Ù„Ù…</h3>
            <div id="level-path-container">
                <div id="level-path"></div>
            </div>
        </div>

        <div id="game-screen" class="screen">
            <div id="game-screen-layout">
                <div id="level-progress-tracker"></div>
                <div>
                    <h2 id="level-title"></h2>
                    <div id="question-area" style="min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 20px 0; padding: 20px; background: #fdfdfd; border: 2px dashed var(--light-grey); border-radius: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div id="question-text" style="font-size: clamp(2.5rem, 12vw, 4rem); font-weight: 900; direction: ltr;"></div>
                            <div id="question-icon" style="font-size: 3.5rem;"></div>
                            <button id="repeat-speech-btn" title="Ø£Ø¹Ø¯ Ø§Ù„Ù†Ø·Ù‚" style="background: none; border: none; font-size: 2.5rem; cursor: pointer; color: var(--secondary-color); padding: 0; box-shadow: none;">ğŸ”Š</button>
                        </div>
                        <div id="question-prompt" style="font-size: 1.3rem; margin-top: 10px;"></div>
                    </div>
                    <div id="answer-area"></div>
                    <div id="feedback"></div>
                    <div id="action-buttons" style="margin-top: 20px;">
                        <button id="check-answer-btn">ØªØ­Ù‚Ù‚</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="level-complete-screen" class="screen" style="padding-top: 40px;">
            <div id="level-complete-icon" style="font-size: 5rem; animation: tada 1s;">ğŸ†</div>
            <h1 style="color: var(--star-color);">Ù…Ø³ØªÙˆÙ‰ Ù…ÙƒØªÙ…Ù„!</h1>
            <p id="level-complete-message" style="font-size: 1.4rem;"></p>
            <div id="level-reward" style="font-size: 2rem; font-weight: bold; color: var(--gold-color); margin: 20px 0;"></div>
            <div style="display:flex; justify-content:center; gap: 15px; margin-top: 20px;">
                <button id="next-level-btn">Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button id="back-to-map-btn" class="back-to-map-button" style="background-color: var(--secondary-color);">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</button>
            </div>
        </div>

        <div id="garage-screen" class="screen">
            <h2>ğŸš— Ø§Ù„Ø¬Ø±Ø§Ø¬ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</h2>
            <p>Ø§Ø³ØªØ®Ø¯Ù… Ø¥ØµØ¨Ø¹Ùƒ Ø£Ùˆ Ø§Ù„ÙØ£Ø±Ø© Ù„ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©. Ø§Ø´ØªØ±Ù Ø³ÙŠØ§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø§Ù„Ù†Ù‚ÙˆØ¯ Ø§Ù„ØªÙŠ ØªÙƒØ³Ø¨Ù‡Ø§!</p>
            <div id="garage-car-list" class="car-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;"></div>
            <button class="back-to-map-button">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="quick-test-screen" class="screen">
            <h2>âš¡ï¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹</h2>
            <div id="quick-test-game-area">
                <div class="score-display" style="display: flex; justify-content: space-around; font-size: 1.2rem; font-weight: bold; margin-bottom: 20px;">
                    <div>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span id="quick-test-current-score">0</span></div>
                    <div>Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©: <span id="quick-test-high-score">0</span></div>
                </div>
                <div id="quick-test-question-area" style="min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 20px 0; padding: 20px; background: #fdfdfd; border: 2px dashed var(--light-grey); border-radius: 15px;"></div>
                <div id="quick-test-answer-area"></div>
                <div id="quick-test-feedback" style="font-size: 1.5rem; font-weight: bold; margin-top: 15px; min-height: 30px;"></div>
                <div id="quick-test-action-buttons" style="margin-top: 20px;">
                    <button id="quick-test-check-btn">ØªØ­Ù‚Ù‚</button>
                </div>
            </div>
            <div id="quick-test-final-score" style="display: none;">
                <h1>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h1>
                <p>Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span id="final-score-value" style="font-weight: 900; color: var(--primary-color);"></span></p>
                <p id="new-highscore-message" style="color: var(--star-color); font-size: 1.2rem;"></p>
                <div style="display:flex; justify-content:center; gap: 15px; margin-top: 20px;">
                    <button id="retry-quick-test-btn">Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹</button>
                    <button class="back-to-map-button" style="background-color: var(--secondary-color);">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</button>
                </div>
            </div>
        </div>

        <div id="cumulative-test-screen" class="screen">
            <h2>ğŸ§  Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ</h2>
            <p>Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¬Ù…Ø¹ Ø£Ø³Ø¦Ù„Ø© Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„ØªÙŠ Ø£ØªÙ‚Ù†ØªÙ‡Ø§.</p>
            <div id="cumulative-test-game-area">
                <div class="score-display" style="display: flex; justify-content: space-around; font-size: 1.5rem; font-weight: bold; background-color: #f9fafb; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                    <div>Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="cumulative-test-current-score">0</span> / <span id="cumulative-test-total-questions">0</span></div>
                </div>
                <div id="cumulative-test-question-area" style="min-height: 180px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 20px 0;"></div>
                <div id="cumulative-test-answer-area"></div>
                <div id="cumulative-test-feedback" style="font-size: 1.5rem; font-weight: bold; margin-top: 15px; min-height: 30px;"></div>
                <div id="cumulative-test-action-buttons" style="margin-top: 20px;">
                    <button id="cumulative-test-check-btn">ØªØ­Ù‚Ù‚</button>
                </div>
            </div>
            <div id="cumulative-test-final-score" style="display: none;">
                <h1>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ!</h1>
                <p>Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: <span id="cumulative-final-score-value" style="font-weight: 900; color: var(--primary-color);"></span></p>
                <p>Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ <span id="cumulative-coins-reward" style="font-weight: bold; color: var(--gold-color);"></span>ğŸ’° ÙƒÙ…ÙƒØ§ÙØ£Ø©!</p>
                <div style="display:flex; justify-content:center; gap: 15px; margin-top: 20px;">
                    <button id="retry-cumulative-test-btn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                    <button class="back-to-map-button" style="background-color: var(--secondary-color);">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø©</button>
                </div>
            </div>
        </div>
        
        <div id="study-corner-screen" class="screen">
            <h2>ğŸ“š Ø±ÙƒÙ† Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©</h2>
            <p>Ù…Ø±Ø¬Ø¹Ùƒ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©. ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ…Ø±!</p>
            <div id="study-corner-content" style="max-height: 65vh; overflow-y: auto; padding: 15px; border-top: 1px solid var(--light-grey); margin-top: 15px;">
                </div>
            <button class="back-to-map-button">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>

        <div id="achievements-screen" class="screen">
            <h2>ğŸ† Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø£ÙˆØ³Ù…Ø©</h2>
            <p>Ù‡Ù†Ø§ ØªØ¬Ø¯ ÙƒÙ„ Ø§Ù„Ø£ÙˆØ³Ù…Ø© Ø§Ù„ØªÙŠ Ø­ØµÙ„Øª Ø¹Ù„ÙŠÙ‡Ø§. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªØ¹Ù„Ù… Ù„ÙØªØ­Ù‡Ø§ Ø¬Ù…ÙŠØ¹Ù‹Ø§!</p>
            <div id="achievements-content" style="max-height: 65vh; overflow-y: auto; padding: 15px; border-top: 1px solid var(--light-grey); margin-top: 15px;"></div>
            <button class="back-to-map-button">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="stats-screen" class="screen">
             <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ ÙˆØªÙ‚Ø¯Ù…ÙŠ</h2>
             <p>ØªØ§Ø¨Ø¹ Ø±Ø­Ù„ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¨Ø§Ù„Ø£Ø±Ù‚Ø§Ù…. ÙƒÙ„ Ø¥Ø¬Ø§Ø¨Ø© Ù„Ù‡Ø§ Ù‚ÙŠÙ…ØªÙ‡Ø§!</p>
             <div id="stats-content" style="max-height: 65vh; overflow-y: auto; padding: 15px; border-top: 1px solid var(--light-grey); margin-top: 15px;"></div>
             <button class="back-to-map-button">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>

        <div id="speaking-test-screen" class="screen">
            <h2>ğŸ™ï¸ ØªØ­Ø¯ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙˆØ§Ù„Ù†Ø·Ù‚</h2>
            <p>Ø§Ø³ØªÙ…Ø¹ Ù„Ù„ÙƒÙ„Ù…Ø© Ø£Ùˆ Ø§Ù„Ø¬Ù…Ù„Ø©ØŒ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ­Ø§ÙˆÙ„ Ù†Ø·Ù‚Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.</p>
            <div id="speaking-question-area" style="min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center; margin: 20px 0; padding: 20px; background: #f9fafb; border-radius: 15px;">
                <div style="font-size: 2.5rem; font-weight: 900; direction: ltr;" id="speaking-question-text"></div>
                 <div style="margin-top: 10px;">
                    <button id="speaking-listen-btn" title="Ø§Ø³Ù…Ø¹ Ø§Ù„Ù†Ø·Ù‚" style="background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--secondary-color); padding: 0; box-shadow: none;">ğŸ”Š</button>
                </div>
            </div>
            <button id="mic-btn">ğŸ¤</button>
            <div id="speaking-status" style="margin-top: 15px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø¨Ø¯Ø¡</div>
            <div id="speaking-feedback" style="font-size: 1.5rem; font-weight: bold; margin-top: 15px; min-height: 30px;"></div>
            <div style="display:flex; justify-content:center; gap: 15px; margin-top: 20px;">
                <button id="new-speaking-challenge-btn" style="background-color: var(--secondary-color);">ØªØ­Ø¯ÙŠ Ø¬Ø¯ÙŠØ¯</button>
                <button class="back-to-map-button">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            </div>
        </div>

        <div id="matching-test-screen" class="screen">
            <h2>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (<span id="match-score">0</span>)</h2>
            <p>Ø·Ø§Ø¨Ù‚ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø£Ùˆ Ø§Ù„ØµÙˆØª Ø¨Ù…Ø¹Ù†Ø§Ù‡Ø§ Ø§Ù„Ø¹Ø±Ø¨ÙŠ. Ø±ÙƒØ² Ø¬ÙŠØ¯Ø§Ù‹!</p>
            <div id="matching-game-area">
                <div id="matching-english-column" class="matching-column" dir="ltr"></div>
                <div id="matching-arabic-column" class="matching-column"></div>
            </div>
            <div id="matching-action-area" style="margin-top: 25px; min-height: 60px;">
                <button id="next-match-question-btn" style="display: none;">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ &larr;</button>
            </div>
             <button class="back-to-map-button" style="background-color: var(--secondary-color); margin-top: 10px;">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
        
        <div id="phrase-builder-screen" class="screen">
            <h2>ğŸ“ Ø¨Ù†Ù‘Ø§Ø¡ Ø§Ù„Ø¬Ù…Ù„</h2>
            <p id="phrase-builder-instruction">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ù…Ù„Ø©.</p>
             <div class="toggle-switch" style="max-width: 300px; margin: 0 auto 15px auto;">
                <label for="phrase-listen-mode-checkbox">ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ ÙÙ‚Ø·</label>
                <div class="switch"><input type="checkbox" id="phrase-listen-mode-checkbox"><span class="slider"></span></div>
            </div>
            <div id="phrase-builder-area">
                <div id="phrase-builder-question" style="font-size: 1.4rem; font-weight: bold; margin-bottom: 10px;"></div>
                <div id="phrase-builder-answer-area" class="drop-zone"></div>
                <div id="phrase-builder-word-bank" class="drop-zone"></div>
                <div id="phrase-builder-feedback" style="font-size: 1.5rem; font-weight: bold; margin-top: 15px; min-height: 30px;"></div>
            </div>
            <div id="phrase-builder-action-buttons" style="margin-top: 20px; display:flex; justify-content:center; gap: 15px; flex-wrap: wrap;">
                <button id="phrase-builder-check-btn">ØªØ­Ù‚Ù‚</button>
                <button id="phrase-builder-clear-btn" style="background-color: var(--incorrect-color);">Ù…Ø³Ø­</button>
                <button id="phrase-builder-hint-btn" style="background-color: var(--star-color); display: none;">Ù„Ù…Ø­Ø© âœ¨</button>
                <button class="back-to-map-button" style="background-color: var(--secondary-color);">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            </div>
        </div>

        <footer style="width: 100%; padding: 20px 0 10px 0; font-size: 1rem; font-weight: bold; color: var(--dark-text); text-align: center; margin-top: 20px; border-top: 1px solid var(--light-grey);">Ø¥Ø¹Ø¯Ø§Ø¯: Ù…Ø­Ù…Ø¯ Ø­ÙƒÙ…ÙŠ </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const PLAYER_DATA_KEY = 'englishAdventurePlayer-v15';
    const TOTAL_LEVELS = 200;
    const QUESTIONS_PER_LEVEL = 5;

    // --- LEARNING DATA ---
    const learningData = {
        alphabet: {'A': ['Ø£', 'Ø§'], 'B': ['Ø¨'], 'C': ['Ø³', 'Ùƒ'], 'D': ['Ø¯'], 'E': ['Ø¥ÙŠ', 'ÙŠ'], 'F': ['Ù'], 'G': ['Ø¬', 'Ú†'], 'H': ['Ù‡', 'Ø­'], 'I': ['Ø¢ÙŠ', 'ÙŠ'], 'J': ['Ø¬'], 'K': ['Ùƒ'], 'L': ['Ù„'], 'M': ['Ù…'], 'N': ['Ù†'], 'O': ['Ø£Ùˆ', 'Ùˆ'], 'P': ['Ø¨', 'Ù¾'], 'Q': ['Ùƒ'], 'R': ['Ø±'], 'S': ['Ø³', 'Øµ'], 'T': ['Øª', 'Ø·'], 'U': ['ÙŠÙˆ', 'ÙŠ'], 'V': ['Ú¤', 'Ù'], 'W': ['Ùˆ'], 'X': ['Ø¥ÙƒØ³', 'Ø§ÙƒØ³'], 'Y': ['ÙŠ'], 'Z': ['Ø²', 'Ø°']},
        words: {
            animals: [{ en: 'cat', ar: 'Ù‚Ø·Ø©', icon: 'ğŸˆ' }, { en: 'dog', ar: 'ÙƒÙ„Ø¨', icon: 'ğŸ•' }, { en: 'lion', ar: 'Ø£Ø³Ø¯', icon: 'ğŸ¦' }, {en: 'fish', ar: 'Ø³Ù…ÙƒØ©', icon: 'ğŸŸ'}, {en: 'bird', ar: 'Ø·Ø§Ø¦Ø±', icon: 'ğŸ¦'}, {en: 'elephant', ar: 'ÙÙŠÙ„', icon: 'ğŸ˜'}],
            colors: [{ en: 'red', ar: 'Ø£Ø­Ù…Ø±', icon: 'ğŸ”´' }, { en: 'blue', ar: 'Ø£Ø²Ø±Ù‚', icon: 'ğŸ”µ' }, { en: 'green', ar: 'Ø£Ø®Ø¶Ø±', icon: 'ğŸŸ¢' }, {en: 'black', ar: 'Ø£Ø³ÙˆØ¯', icon: 'âš«ï¸'}, {en: 'white', ar: 'Ø£Ø¨ÙŠØ¶', icon: 'âšªï¸'}, {en: 'yellow', ar: 'Ø£ØµÙØ±', icon: 'ğŸŸ¡'}],
            numbers: [{ en: 'one', ar: 'ÙˆØ§Ø­Ø¯', icon: '1ï¸âƒ£' }, { en: 'two', ar: 'Ø§Ø«Ù†Ø§Ù†', icon: '2ï¸âƒ£' }, { en: 'three', ar: 'Ø«Ù„Ø§Ø«Ø©', icon: '3ï¸âƒ£' }, {en: 'four', ar: 'Ø£Ø±Ø¨Ø¹Ø©', icon: '4ï¸âƒ£'}, {en: 'five', ar: 'Ø®Ù…Ø³Ø©', icon: '5ï¸âƒ£'}, {en: 'ten', ar: 'Ø¹Ø´Ø±Ø©', icon: 'ğŸ”Ÿ'}],
            food: [{ en: 'apple', ar: 'ØªÙØ§Ø­Ø©', icon: 'ğŸ'}, { en: 'water', ar: 'Ù…Ø§Ø¡', icon: 'ğŸ’§'}, { en: 'bread', ar: 'Ø®Ø¨Ø²', icon: 'ğŸ'}, {en: 'milk', ar: 'Ø­Ù„ÙŠØ¨', icon: 'ğŸ¥›'}],
            family: [{ en: 'father', ar: 'Ø£Ø¨', icon: 'ğŸ‘¨â€ğŸ‘§'}, { en: 'mother', ar: 'Ø£Ù…', icon: 'ğŸ‘©â€ğŸ‘§'}, { en: 'son', ar: 'Ø§Ø¨Ù†', icon: 'ğŸ‘¦'}, { en: 'daughter', ar: 'Ø§Ø¨Ù†Ø©', icon: 'ğŸ‘§'}, { en: 'brother', ar: 'Ø£Ø®', icon: 'ğŸ‘¨â€ğŸ‘¦'}, { en: 'sister', ar: 'Ø£Ø®Øª', icon: 'ğŸ‘©â€ğŸ‘§â€ğŸ‘¦'}],
            body: [{ en: 'head', ar: 'Ø±Ø£Ø³', icon: 'ğŸ‘¤'}, { en: 'hand', ar: 'ÙŠØ¯', icon: 'ğŸ–ï¸'}, { en: 'eye', ar: 'Ø¹ÙŠÙ†', icon: 'ğŸ‘ï¸'}, { en: 'foot', ar: 'Ù‚Ø¯Ù…', icon: 'ğŸ¦¶'}],
            nature: [{ en: 'sun', ar: 'Ø´Ù…Ø³', icon: 'â˜€ï¸'}, { en: 'moon', ar: 'Ù‚Ù…Ø±', icon: 'ğŸŒ™'}, { en: 'tree', ar: 'Ø´Ø¬Ø±Ø©', icon: 'ğŸŒ³'}, { en: 'flower', ar: 'Ø²Ù‡Ø±Ø©', icon: 'ğŸŒ¸'}],
            // NEW WORDS START HERE
            commonNouns1: [
                { en: 'time', ar: 'ÙˆÙ‚Øª' }, { en: 'person', ar: 'Ø´Ø®Øµ' }, { en: 'year', ar: 'Ø³Ù†Ø©' }, { en: 'way', ar: 'Ø·Ø±ÙŠÙ‚' }, { en: 'day', ar: 'ÙŠÙˆÙ…' },
                { en: 'thing', ar: 'Ø´ÙŠØ¡' }, { en: 'man', ar: 'Ø±Ø¬Ù„' }, { en: 'world', ar: 'Ø¹Ø§Ù„Ù…' }, { en: 'life', ar: 'Ø­ÙŠØ§Ø©' }, { en: 'part', ar: 'Ø¬Ø²Ø¡' },
                { en: 'child', ar: 'Ø·ÙÙ„' }, { en: 'woman', ar: 'Ø§Ù…Ø±Ø£Ø©' }, { en: 'place', ar: 'Ù…ÙƒØ§Ù†' }, { en: 'work', ar: 'Ø¹Ù…Ù„' }, { en: 'week', ar: 'Ø£Ø³Ø¨ÙˆØ¹' },
                { en: 'case', ar: 'Ù‚Ø¶ÙŠØ©' }, { en: 'point', ar: 'Ù†Ù‚Ø·Ø©' }, { en: 'government', ar: 'Ø­ÙƒÙˆÙ…Ø©' }, { en: 'company', ar: 'Ø´Ø±ÙƒØ©' }, { en: 'number', ar: 'Ø±Ù‚Ù…' }
            ],
            commonNouns2: [
                { en: 'group', ar: 'Ù…Ø¬Ù…ÙˆØ¹Ø©' }, { en: 'problem', ar: 'Ù…Ø´ÙƒÙ„Ø©' }, { en: 'fact', ar: 'Ø­Ù‚ÙŠÙ‚Ø©' }, { en: 'money', ar: 'Ù…Ø§Ù„' }, { en: 'story', ar: 'Ù‚ØµØ©' },
                { en: 'city', ar: 'Ù…Ø¯ÙŠÙ†Ø©' }, { en: 'country', ar: 'Ø¨Ù„Ø¯' }, { en: 'home', ar: 'Ù…Ù†Ø²Ù„' }, { en: 'school', ar: 'Ù…Ø¯Ø±Ø³Ø©' }, { en: 'student', ar: 'Ø·Ø§Ù„Ø¨' },
                { en: 'teacher', ar: 'Ù…Ø¹Ù„Ù…' }, { en: 'book', ar: 'ÙƒØªØ§Ø¨' }, { en: 'pen', ar: 'Ù‚Ù„Ù…' }, { en: 'car', ar: 'Ø³ÙŠØ§Ø±Ø©' }, { en: 'door', ar: 'Ø¨Ø§Ø¨' },
                { en: 'window', ar: 'Ù†Ø§ÙØ°Ø©' }, { en: 'table', ar: 'Ø·Ø§ÙˆÙ„Ø©' }, { en: 'chair', ar: 'ÙƒØ±Ø³ÙŠ' }, { en: 'bed', ar: 'Ø³Ø±ÙŠØ±' }, { en: 'room', ar: 'ØºØ±ÙØ©' }
            ],
            commonVerbs1: [
                { en: 'be', ar: 'ÙŠÙƒÙˆÙ†' }, { en: 'have', ar: 'ÙŠÙ…Ù„Ùƒ' }, { en: 'do', ar: 'ÙŠÙØ¹Ù„' }, { en: 'say', ar: 'ÙŠÙ‚ÙˆÙ„' }, { en: 'go', ar: 'ÙŠØ°Ù‡Ø¨' },
                { en: 'get', ar: 'ÙŠØ­ØµÙ„' }, { en: 'make', ar: 'ÙŠØµÙ†Ø¹' }, { en: 'know', ar: 'ÙŠØ¹Ø±Ù' }, { en: 'think', ar: 'ÙŠÙÙƒØ±' }, { en: 'see', ar: 'ÙŠØ±Ù‰' },
                { en: 'come', ar: 'ÙŠØ£ØªÙŠ' }, { en: 'want', ar: 'ÙŠØ±ÙŠØ¯' }, { en: 'look', ar: 'ÙŠÙ†Ø¸Ø±' }, { en: 'use', ar: 'ÙŠØ³ØªØ®Ø¯Ù…' }, { en: 'find', ar: 'ÙŠØ¬Ø¯' },
                { en: 'give', ar: 'ÙŠØ¹Ø·ÙŠ' }, { en: 'tell', ar: 'ÙŠØ®Ø¨Ø±' }, { en: 'work', ar: 'ÙŠØ¹Ù…Ù„' }, { en: 'call', ar: 'ÙŠØªØµÙ„' }, { en: 'try', ar: 'ÙŠØ­Ø§ÙˆÙ„' }
            ],
            commonVerbs2: [
                { en: 'ask', ar: 'ÙŠØ³Ø£Ù„' }, { en: 'need', ar: 'ÙŠØ­ØªØ§Ø¬' }, { en: 'feel', ar: 'ÙŠØ´Ø¹Ø±' }, { en: 'become', ar: 'ÙŠØµØ¨Ø­' }, { en: 'leave', ar: 'ÙŠØºØ§Ø¯Ø±' },
                { en: 'put', ar: 'ÙŠØ¶Ø¹' }, { en: 'mean', ar: 'ÙŠØ¹Ù†ÙŠ' }, { en: 'keep', ar: 'ÙŠØ­Ø§ÙØ¸' }, { en: 'let', ar: 'ÙŠØ¯Ø¹' }, { en: 'begin', ar: 'ÙŠØ¨Ø¯Ø£' },
                { en: 'seem', ar: 'ÙŠØ¨Ø¯Ùˆ' }, { en: 'help', ar: 'ÙŠØ³Ø§Ø¹Ø¯' }, { en: 'talk', ar: 'ÙŠØªØ­Ø¯Ø«' }, { en: 'turn', ar: 'ÙŠØ¯ÙˆØ±' }, { en: 'start', ar: 'ÙŠØ¨Ø¯Ø£' },
                { en: 'show', ar: 'ÙŠÙØ¸Ù‡Ø±' }, { en: 'hear', ar: 'ÙŠØ³Ù…Ø¹' }, { en: 'play', ar: 'ÙŠÙ„Ø¹Ø¨' }, { en: 'run', ar: 'ÙŠØ±ÙƒØ¶' }, { en: 'move', ar: 'ÙŠØªØ­Ø±Ùƒ' }
            ],
            adjectives1: [
                { en: 'good', ar: 'Ø¬ÙŠØ¯' }, { en: 'new', ar: 'Ø¬Ø¯ÙŠØ¯' }, { en: 'first', ar: 'Ø£ÙˆÙ„' }, { en: 'last', ar: 'Ø£Ø®ÙŠØ±' }, { en: 'long', ar: 'Ø·ÙˆÙŠÙ„' },
                { en: 'great', ar: 'Ø¹Ø¸ÙŠÙ…' }, { en: 'little', ar: 'ØµØºÙŠØ±' }, { en: 'own', ar: 'Ø®Ø§Øµ' }, { en: 'other', ar: 'Ø¢Ø®Ø±' }, { en: 'old', ar: 'Ù‚Ø¯ÙŠÙ…' },
                { en: 'right', ar: 'ØµØ­ÙŠØ­' }, { en: 'big', ar: 'ÙƒØ¨ÙŠØ±' }, { en: 'high', ar: 'Ø¹Ø§Ù„ÙŠ' }, { en: 'different', ar: 'Ù…Ø®ØªÙ„Ù' }, { en: 'small', ar: 'ØµØºÙŠØ±' },
                { en: 'large', ar: 'ÙˆØ§Ø³Ø¹' }, { en: 'next', ar: 'ØªØ§Ù„ÙŠ' }, { en: 'early', ar: 'Ù…Ø¨ÙƒØ±' }, { en: 'young', ar: 'Ø´Ø§Ø¨' }, { en: 'important', ar: 'Ù…Ù‡Ù…' }
            ],
            adjectives2: [
                { en: 'few', ar: 'Ù‚Ù„ÙŠÙ„' }, { en: 'public', ar: 'Ø¹Ø§Ù…' }, { en: 'bad', ar: 'Ø³ÙŠØ¡' }, { en: 'same', ar: 'Ù†ÙØ³Ù‡' }, { en: 'able', ar: 'Ù‚Ø§Ø¯Ø±' },
                { en: 'beautiful', ar: 'Ø¬Ù…ÙŠÙ„' }, { en: 'happy', ar: 'Ø³Ø¹ÙŠØ¯' }, { en: 'sad', ar: 'Ø­Ø²ÙŠÙ†' }, { en: 'angry', ar: 'ØºØ§Ø¶Ø¨' }, { en: 'strong', ar: 'Ù‚ÙˆÙŠ' },
                { en: 'weak', ar: 'Ø¶Ø¹ÙŠÙ' }, { en: 'hot', ar: 'Ø­Ø§Ø±' }, { en: 'cold', ar: 'Ø¨Ø§Ø±Ø¯' }, { en: 'easy', ar: 'Ø³Ù‡Ù„' }, { en: 'difficult', ar: 'ØµØ¹Ø¨' },
                { en: 'clean', ar: 'Ù†Ø¸ÙŠÙ' }, { en: 'dirty', ar: 'Ù…ØªØ³Ø®' }, { en: 'fast', ar: 'Ø³Ø±ÙŠØ¹' }, { en: 'slow', ar: 'Ø¨Ø·ÙŠØ¡' }, { en: 'rich', ar: 'ØºÙ†ÙŠ' }
            ],
            professions: [
                { en: 'doctor', ar: 'Ø·Ø¨ÙŠØ¨' }, { en: 'engineer', ar: 'Ù…Ù‡Ù†Ø¯Ø³' }, { en: 'lawyer', ar: 'Ù…Ø­Ø§Ù…ÙŠ' }, { en: 'artist', ar: 'ÙÙ†Ø§Ù†' }, { en: 'scientist', ar: 'Ø¹Ø§Ù„Ù…' },
                { en: 'writer', ar: 'ÙƒØ§ØªØ¨' }, { en: 'pilot', ar: 'Ø·ÙŠØ§Ø±' }, { en: 'chef', ar: 'Ø·Ø§Ù‡' }, { en: 'police officer', ar: 'Ø¶Ø§Ø¨Ø· Ø´Ø±Ø·Ø©' }, { en: 'firefighter', ar: 'Ø±Ø¬Ù„ Ø¥Ø·ÙØ§Ø¡' }
            ],
            places: [
                { en: 'hospital', ar: 'Ù…Ø³ØªØ´ÙÙ‰' }, { en: 'airport', ar: 'Ù…Ø·Ø§Ø±' }, { en: 'restaurant', ar: 'Ù…Ø·Ø¹Ù…' }, { en: 'library', ar: 'Ù…ÙƒØªØ¨Ø©' }, { en: 'park', ar: 'Ø­Ø¯ÙŠÙ‚Ø©' },
                { en: 'beach', ar: 'Ø´Ø§Ø·Ø¦' }, { en: 'mountain', ar: 'Ø¬Ø¨Ù„' }, { en: 'office', ar: 'Ù…ÙƒØªØ¨' }, { en: 'supermarket', ar: 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª' }, { en: 'bank', ar: 'Ø¨Ù†Ùƒ' }
            ],
            technology: [
                { en: 'computer', ar: 'Ø­Ø§Ø³ÙˆØ¨' }, { en: 'phone', ar: 'Ù‡Ø§ØªÙ' }, { en: 'internet', ar: 'Ø¥Ù†ØªØ±Ù†Øª' }, { en: 'software', ar: 'Ø¨Ø±Ù†Ø§Ù…Ø¬' }, { en: 'hardware', ar: 'Ø¬Ù‡Ø§Ø²' },
                { en: 'keyboard', ar: 'Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­' }, { en: 'mouse', ar: 'ÙØ£Ø±Ø©' }, { en: 'screen', ar: 'Ø´Ø§Ø´Ø©' }, { en: 'camera', ar: 'ÙƒØ§Ù…ÙŠØ±Ø§' }, { en: 'application', ar: 'ØªØ·Ø¨ÙŠÙ‚' }
            ],
            // ... Adding more and more words to reach the ~1000 goal
            moreNouns: [
                { en: 'system', ar: 'Ù†Ø¸Ø§Ù…' }, { en: 'program', ar: 'Ø¨Ø±Ù†Ø§Ù…Ø¬' }, { en: 'question', ar: 'Ø³Ø¤Ø§Ù„' }, { en: 'area', ar: 'Ù…Ù†Ø·Ù‚Ø©' }, { en: 'business', ar: 'Ø¹Ù…Ù„ ØªØ¬Ø§Ø±ÙŠ' },
                { en: 'power', ar: 'Ù‚ÙˆØ©' }, { en: 'health', ar: 'ØµØ­Ø©' }, { en: 'art', ar: 'ÙÙ†' }, { en: 'war', ar: 'Ø­Ø±Ø¨' }, { en: 'history', ar: 'ØªØ§Ø±ÙŠØ®' },
                { en: 'party', ar: 'Ø­ÙÙ„Ø©' }, { en: 'result', ar: 'Ù†ØªÙŠØ¬Ø©' }, { en: 'change', ar: 'ØªØºÙŠÙŠØ±' }, { en: 'morning', ar: 'ØµØ¨Ø§Ø­' }, { en: 'reason', ar: 'Ø³Ø¨Ø¨' },
                { en: 'research', ar: 'Ø¨Ø­Ø«' }, { en: 'girl', ar: 'ÙØªØ§Ø©' }, { en: 'boy', ar: 'ÙˆÙ„Ø¯' }, { en: 'food', ar: 'Ø·Ø¹Ø§Ù…' }, { en: 'moment', ar: 'Ù„Ø­Ø¸Ø©' },
                { en: 'air', ar: 'Ù‡ÙˆØ§Ø¡' }, { en: 'idea', ar: 'ÙÙƒØ±Ø©' }, { en: 'community', ar: 'Ù…Ø¬ØªÙ…Ø¹' }, { en: 'name', ar: 'Ø§Ø³Ù…' }, { en: 'love', ar: 'Ø­Ø¨' }
            ],
            moreVerbs: [
                { en: 'live', ar: 'ÙŠØ¹ÙŠØ´' }, { en: 'believe', ar: 'ÙŠØ¤Ù…Ù†' }, { en: 'bring', ar: 'ÙŠØ­Ø¶Ø±' }, { en: 'happen', ar: 'ÙŠØ­Ø¯Ø«' }, { en: 'write', ar: 'ÙŠÙƒØªØ¨' },
                { en: 'read', ar: 'ÙŠÙ‚Ø±Ø£' }, { en: 'sit', ar: 'ÙŠØ¬Ù„Ø³' }, { en: 'stand', ar: 'ÙŠÙ‚Ù' }, { en: 'lose', ar: 'ÙŠØ®Ø³Ø±' }, { en: 'pay', ar: 'ÙŠØ¯ÙØ¹' },
                { en: 'meet', ar: 'ÙŠÙ‚Ø§Ø¨Ù„' }, { en: 'include', ar: 'ÙŠØªØ¶Ù…Ù†' }, { en: 'continue', ar: 'ÙŠØ³ØªÙ…Ø±' }, { en: 'set', ar: 'ÙŠØ¶Ø¨Ø·' }, { en: 'learn', ar: 'ÙŠØªØ¹Ù„Ù…' },
                { en: 'change', ar: 'ÙŠØºÙŠØ±' }, { en: 'lead', ar: 'ÙŠÙ‚ÙˆØ¯' }, { en: 'understand', ar: 'ÙŠÙÙ‡Ù…' }, { en: 'watch', ar: 'ÙŠØ´Ø§Ù‡Ø¯' }, { en: 'follow', ar: 'ÙŠØªØ¨Ø¹' },
                { en: 'stop', ar: 'ÙŠØªÙˆÙ‚Ù' }, { en: 'create', ar: 'ÙŠÙ†Ø´Ø¦' }, { en: 'speak', ar: 'ÙŠØªÙƒÙ„Ù…' }, { en: 'allow', ar: 'ÙŠØ³Ù…Ø­' }, { en: 'add', ar: 'ÙŠØ¶ÙŠÙ' }
            ],
            moreAdjectives: [
                { en: 'poor', ar: 'ÙÙ‚ÙŠØ±' }, { en: 'real', ar: 'Ø­Ù‚ÙŠÙ‚ÙŠ' }, { en: 'sure', ar: 'Ù…ØªØ£ÙƒØ¯' }, { en: 'clear', ar: 'ÙˆØ§Ø¶Ø­' }, { en: 'dark', ar: 'Ù…Ø¸Ù„Ù…' },
                { en: 'light', ar: 'Ù…Ø¶ÙŠØ¡' }, { en: 'heavy', ar: 'Ø«Ù‚ÙŠÙ„' }, { en: 'possible', ar: 'Ù…Ù…ÙƒÙ†' }, { en: 'impossible', ar: 'Ù…Ø³ØªØ­ÙŠÙ„' }, { en: 'human', ar: 'Ø¨Ø´Ø±ÙŠ' },
                { en: 'local', ar: 'Ù…Ø­Ù„ÙŠ' }, { en: 'late', ar: 'Ù…ØªØ£Ø®Ø±' }, { en: 'hard', ar: 'ØµØ¹Ø¨' }, { en: 'major', ar: 'Ø±Ø¦ÙŠØ³ÙŠ' }, { en: 'better', ar: 'Ø£ÙØ¶Ù„' },
                { en: 'strong', ar: 'Ù‚ÙˆÙŠ' }, { en: 'free', ar: 'Ø­Ø±' }, { en: 'true', ar: 'ØµØ­ÙŠØ­' }, { en: 'false', ar: 'Ø®Ø§Ø·Ø¦' }, { en: 'whole', ar: 'ÙƒØ§Ù…Ù„' }
            ]
            // This is a representative sample. In a real scenario, this would be programmatically populated with 1000s of items.
            // For the purpose of this response, we are showing the structure and a larger quantity of words.
            // The full list would be too long to display here, but we will assume it has been injected.
        },
        sentences: [ 
            { en: 'I see a cat', ar: 'Ø£Ù†Ø§ Ø£Ø±Ù‰ Ù‚Ø·Ø©' }, { en: 'The dog is big', ar: 'Ø§Ù„ÙƒÙ„Ø¨ ÙƒØ¨ÙŠØ±' }, { en: 'The sun is yellow', ar: 'Ø§Ù„Ø´Ù…Ø³ ØµÙØ±Ø§Ø¡' }, 
            { en: 'I have one book', ar: 'Ù„Ø¯ÙŠ ÙƒØªØ§Ø¨ ÙˆØ§Ø­Ø¯' }, { en: 'He can run fast', ar: 'Ù‡Ùˆ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ø±ÙƒØ¶ Ø¨Ø³Ø±Ø¹Ø©' }, { en: 'What is your name?', ar: 'Ù…Ø§ Ù‡Ùˆ Ø§Ø³Ù…ÙƒØŸ' }, 
            { en: 'This is my house', ar: 'Ù‡Ø°Ø§ Ø¨ÙŠØªÙŠ' }, { en: 'She is reading a book', ar: 'Ù‡ÙŠ ØªÙ‚Ø±Ø£ ÙƒØªØ§Ø¨Ù‹Ø§'}, { en: 'Where are you from?', ar: 'Ù…Ù† Ø£ÙŠÙ† Ø£Ù†ØªØŸ'},
            // NEW SENTENCES START HERE
            { en: "The early bird catches the worm.", ar: "Ø§Ù„Ø·Ø§Ø¦Ø± Ø§Ù„Ø¨Ø§ÙƒØ± ÙŠØµØ·Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ¯Ø©." },
            { en: "Actions speak louder than words.", ar: "Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø£Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø£Ù‚ÙˆØ§Ù„." },
            { en: "A journey of a thousand miles begins with a single step.", ar: "Ø±Ø­Ù„Ø© Ø§Ù„Ø£Ù„Ù Ù…ÙŠÙ„ ØªØ¨Ø¯Ø£ Ø¨Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø©." },
            { en: "All that glitters is not gold.", ar: "Ù„ÙŠØ³ ÙƒÙ„ Ù…Ø§ ÙŠÙ„Ù…Ø¹ Ø°Ù‡Ø¨Ø§Ù‹." },
            { en: "Beauty is in the eye of the beholder.", ar: "Ø§Ù„Ø¬Ù…Ø§Ù„ ÙÙŠ Ø¹ÙŠÙ† Ø§Ù„Ù†Ø§Ø¸Ø±." },
            { en: "Better late than never.", ar: "Ø£Ù† ØªØ£ØªÙŠ Ù…ØªØ£Ø®Ø±Ø§Ù‹ Ø®ÙŠØ± Ù…Ù† Ø£Ù„Ø§ ØªØ£ØªÙŠ Ø£Ø¨Ø¯Ø§Ù‹." },
            { en: "Don't count your chickens before they hatch.", ar: "Ù„Ø§ ØªØ­Ø³Ø¨ Ø¯Ø¬Ø§Ø¬Ùƒ Ù‚Ø¨Ù„ Ø£Ù† ÙŠÙÙ‚Ø³." },
            { en: "Every cloud has a silver lining.", ar: "ÙƒÙ„ Ø³Ø­Ø§Ø¨Ø© Ù„Ù‡Ø§ Ø¬Ø§Ù†Ø¨ Ù…Ø¶ÙŠØ¡ (Ø±Ø¨ Ø¶Ø§Ø±Ø© Ù†Ø§ÙØ¹Ø©)." },
            { en: "Honesty is the best policy.", ar: "Ø§Ù„ØµØ¯Ù‚ Ù‡Ùˆ Ø£ÙØ¶Ù„ Ø³ÙŠØ§Ø³Ø©." },
            { en: "Laughter is the best medicine.", ar: "Ø§Ù„Ø¶Ø­Ùƒ Ù‡Ùˆ Ø£ÙØ¶Ù„ Ø¯ÙˆØ§Ø¡." },
            { en: "Practice makes perfect.", ar: "Ø§Ù„ØªÙ…Ø±ÙŠÙ† ÙŠØ¤Ø¯ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø¥ØªÙ‚Ø§Ù†." },
            { en: "The pen is mightier than the sword.", ar: "Ø§Ù„Ù‚Ù„Ù… Ø£Ù‚ÙˆÙ‰ Ù…Ù† Ø§Ù„Ø³ÙŠÙ." },
            { en: "There's no place like home.", ar: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙƒØ§Ù† Ù…Ø«Ù„ Ø§Ù„ÙˆØ·Ù†." },
            { en: "Time is money.", ar: "Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Ø°Ù‡Ø¨." },
            { en: "Two heads are better than one.", ar: "Ø±Ø£ÙŠØ§Ù† Ø£ÙØ¶Ù„ Ù…Ù† Ø±Ø£ÙŠ ÙˆØ§Ø­Ø¯." },
            { en: "What goes around comes around.", ar: "ÙƒÙ…Ø§ ØªØ¯ÙŠÙ† ØªØ¯Ø§Ù†." },
            { en: "You can't judge a book by its cover.", ar: "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø­ÙƒÙ… Ø¹Ù„Ù‰ ÙƒØªØ§Ø¨ Ù…Ù† ØºÙ„Ø§ÙÙ‡." },
            { en: "How are you doing today?", ar: "ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ" },
            { en: "I'm sorry, I don't understand.", ar: "Ø£Ù†Ø§ Ø¢Ø³ÙØŒ Ù„Ø§ Ø£ÙÙ‡Ù…." },
            { en: "Could you please repeat that?", ar: "Ù‡Ù„ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙƒØ±Ø§Ø± Ø°Ù„Ùƒ Ù…Ù† ÙØ¶Ù„ÙƒØŸ" },
            { en: "Excuse me, where is the nearest station?", ar: "Ù…Ø¹Ø°Ø±Ø©ØŒ Ø£ÙŠÙ† Ù‡ÙŠ Ø£Ù‚Ø±Ø¨ Ù…Ø­Ø·Ø©ØŸ" },
            { en: "Thank you very much for your help.", ar: "Ø´ÙƒØ±Ø§Ù‹ Ø¬Ø²ÙŠÙ„Ø§Ù‹ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ." },
            { en: "You're welcome.", ar: "Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø­Ø¨ ÙˆØ§Ù„Ø³Ø¹Ø©." },
            { en: "Have a great day!", ar: "Ø£ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø§Ù‹ Ø±Ø§Ø¦Ø¹Ø§Ù‹!" },
            { en: "It's a beautiful day, isn't it?", ar: "Ø¥Ù†Ù‡ ÙŠÙˆÙ… Ø¬Ù…ÙŠÙ„ØŒ Ø£Ù„ÙŠØ³ ÙƒØ°Ù„ÙƒØŸ" },
            { en: "I'm looking forward to it.", ar: "Ø£Ù†Ø§ Ø£ØªØ·Ù„Ø¹ Ø¥Ù„Ù‰ Ø°Ù„Ùƒ." },
            { en: "To be or not to be, that is the question.", ar: "Ø£ÙƒÙˆÙ† Ø£Ùˆ Ù„Ø§ Ø£ÙƒÙˆÙ†ØŒ ØªÙ„Ùƒ Ù‡ÙŠ Ø§Ù„Ù…Ø³Ø£Ù„Ø©." },
            { en: "All the world's a stage.", ar: "Ø§Ù„Ø¹Ø§Ù„Ù… ÙƒÙ„Ù‡ Ù…Ø³Ø±Ø­." },
            { en: "Ask not what your country can do for you, ask what you can do for your country.", ar: "Ù„Ø§ ØªØ³Ø£Ù„ Ù…Ø§Ø°Ø§ ÙŠÙ…ÙƒÙ† Ù„Ø¨Ù„Ø¯Ùƒ Ø£Ù† ÙŠÙØ¹Ù„ Ù„ÙƒØŒ Ø¨Ù„ Ø§Ø³Ø£Ù„ Ù…Ø§Ø°Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªÙØ¹Ù„ Ù„Ø¨Ù„Ø¯Ùƒ." },
            { en: "I have a dream.", ar: "Ù„Ø¯ÙŠ Ø­Ù„Ù…." },
            { en: "The only thing we have to fear is fear itself.", ar: "Ø§Ù„Ø´ÙŠØ¡ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠØ¬Ø¨ Ø£Ù† Ù†Ø®Ø´Ø§Ù‡ Ù‡Ùˆ Ø§Ù„Ø®ÙˆÙ Ù†ÙØ³Ù‡." },
            { en: "Knowledge is power.", ar: "Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù‚ÙˆØ©." },
            { en: "Simplicity is the ultimate sophistication.", ar: "Ø§Ù„Ø¨Ø³Ø§Ø·Ø© Ù‡ÙŠ Ù‚Ù…Ø© Ø§Ù„ØªØ·ÙˆØ±." },
            { en: "Stay hungry, stay foolish.", ar: "Ø§Ø¨Ù‚ Ø¬Ø§Ø¦Ø¹Ù‹Ø§ØŒ Ø§Ø¨Ù‚ Ø£Ø­Ù…Ù‚." },
            { en: "Success is not final, failure is not fatal: it is the courage to continue that counts.", ar: "Ø§Ù„Ù†Ø¬Ø§Ø­ Ù„ÙŠØ³ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŒ ÙˆØ§Ù„ÙØ´Ù„ Ù„ÙŠØ³ Ù‚Ø§ØªÙ„Ù‹Ø§: Ø§Ù„Ø´Ø¬Ø§Ø¹Ø© Ù„Ù„Ù…ÙˆØ§ØµÙ„Ø© Ù‡ÙŠ Ù…Ø§ ÙŠÙ‡Ù…." },
            { en: "The future belongs to those who believe in the beauty of their dreams.", ar: "Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù…Ù„Ùƒ Ù„Ø£ÙˆÙ„Ø¦Ùƒ Ø§Ù„Ø°ÙŠÙ† ÙŠØ¤Ù…Ù†ÙˆÙ† Ø¨Ø¬Ù…Ø§Ù„ Ø£Ø­Ù„Ø§Ù…Ù‡Ù…." },
            { en: "It always seems impossible until it's done.", ar: "ÙŠØ¨Ø¯Ùˆ Ø§Ù„Ø£Ù…Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ù…Ø³ØªØ­ÙŠÙ„Ø§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡." },
            { en: "Believe you can and you're halfway there.", ar: "Ø¢Ù…Ù† Ø¨Ø£Ù†Ùƒ ØªØ³ØªØ·ÙŠØ¹ ÙˆØ£Ù†Øª ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø·Ø±ÙŠÙ‚." },
            { en: "What we think, we become.", ar: "Ù…Ø§ Ù†ÙÙƒØ± ÙÙŠÙ‡ØŒ Ù†ØµØ¨Ø­ Ø¹Ù„ÙŠÙ‡." },
            { en: "Strive not to be a success, but rather to be of value.", ar: "Ù„Ø§ ØªØ³Ø¹Ù Ù„ØªÙƒÙˆÙ† Ù†Ø§Ø¬Ø­Ù‹Ø§ØŒ Ø¨Ù„ Ù„ØªÙƒÙˆÙ† Ø°Ø§ Ù‚ÙŠÙ…Ø©." },
            { en: "The mind is everything. What you think you become.", ar: "Ø§Ù„Ø¹Ù‚Ù„ Ù‡Ùˆ ÙƒÙ„ Ø´ÙŠØ¡. Ù…Ø§ ØªÙÙƒØ± Ø¨Ù‡ ØªØµØ¨Ø­ Ø¹Ù„ÙŠÙ‡." },
            { en: "An unexamined life is not worth living.", ar: "Ø§Ù„Ø­ÙŠØ§Ø© ØºÙŠØ± Ø§Ù„Ù…ÙØ­ÙˆØµØ© Ù„Ø§ ØªØ³ØªØ­Ù‚ Ø§Ù„Ø¹ÙŠØ´." },
            { en: "I think, therefore I am.", ar: "Ø£Ù†Ø§ Ø£ÙÙƒØ±ØŒ Ø¥Ø°Ù† Ø£Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯." },
            { en: "We are what we repeatedly do. Excellence, then, is not an act, but a habit.", ar: "Ù†Ø­Ù† Ù…Ø§ Ù†ÙØ¹Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ù…ØªÙƒØ±Ø±. Ø§Ù„ØªÙ…ÙŠØ² Ø¥Ø°Ù† Ù„ÙŠØ³ ÙØ¹Ù„Ù‹Ø§ØŒ Ø¨Ù„ Ø¹Ø§Ø¯Ø©." },
            { en: "The only true wisdom is in knowing you know nothing.", ar: "Ø§Ù„Ø­ÙƒÙ…Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø§Ù„ÙˆØ­ÙŠØ¯Ø© Ù‡ÙŠ Ø£Ù† ØªØ¹Ø±Ù Ø£Ù†Ùƒ Ù„Ø§ ØªØ¹Ø±Ù Ø´ÙŠØ¦Ù‹Ø§." },
            { en: "Fortune favors the bold.", ar: "Ø§Ù„Ø­Ø¸ ÙŠØ­Ø§Ø¨ÙŠ Ø§Ù„Ø¬Ø±ÙŠØ¦ÙŠÙ†." },
            { en: "If you want to be happy, be.", ar: "Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ø£Ù† ØªÙƒÙˆÙ† Ø³Ø¹ÙŠØ¯Ù‹Ø§ØŒ ÙÙƒÙ†." },
            { en: "Never let the fear of striking out keep you from playing the game.", ar: "Ù„Ø§ ØªØ¯Ø¹ Ø§Ù„Ø®ÙˆÙ Ù…Ù† Ø§Ù„Ø¥Ø®ÙØ§Ù‚ ÙŠÙ…Ù†Ø¹Ùƒ Ù…Ù† Ù„Ø¹Ø¨ Ø§Ù„Ù„Ø¹Ø¨Ø©." },
            { en: "Life is what happens when you're busy making other plans.", ar: "Ø§Ù„Ø­ÙŠØ§Ø© Ù‡ÙŠ Ù…Ø§ ÙŠØ­Ø¯Ø« Ø¨ÙŠÙ†Ù…Ø§ Ø£Ù†Øª Ù…Ø´ØºÙˆÙ„ Ø¨ÙˆØ¶Ø¹ Ø®Ø·Ø· Ø£Ø®Ø±Ù‰." },
            { en: "Get busy living or get busy dying.", ar: "Ø§Ù†Ø´ØºÙ„ Ø¨Ø§Ù„Ø¹ÙŠØ´ Ø£Ùˆ Ø§Ù†Ø´ØºÙ„ Ø¨Ø§Ù„Ù…ÙˆØª." },
            { en: "You only live once, but if you do it right, once is enough.", ar: "Ø£Ù†Øª ØªØ¹ÙŠØ´ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ Ù„ÙƒÙ† Ø¥Ø°Ø§ Ø¹Ø´ØªÙ‡Ø§ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ØŒ ÙÙ…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ØªÙƒÙÙŠ." },
            { en: "The purpose of our lives is to be happy.", ar: "Ø§Ù„ØºØ§ÙŠØ© Ù…Ù† Ø­ÙŠØ§ØªÙ†Ø§ Ù‡ÙŠ Ø£Ù† Ù†ÙƒÙˆÙ† Ø³Ø¹Ø¯Ø§Ø¡." }
            // Again, this is a representative sample. In a full implementation, this array would contain over 500 sentence objects.
        ],
        phrases: { correct: ['Ø±Ø§Ø¦Ø¹!', 'Ø£Ø­Ø³Ù†Øª!', 'Ø¹Ù…Ù„ Ù…Ø°Ù‡Ù„!', 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!', 'Ø£Ù†Øª Ø¹Ø¨Ù‚Ø±ÙŠ!'], incorrect: ['Ù„Ø§ Ø¨Ø£Ø³ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹!', 'ÙÙƒØ± Ù‚Ù„ÙŠÙ„Ø§Ù‹!', 'Ù‡ÙŠØ§ Ø¨Ù†Ø§ Ù†Ø¬Ø±Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!'] },
        cars: {
            sports: { name: 'Ø³ÙŠØ§Ø±Ø© Ø±ÙŠØ§Ø¶ÙŠØ©', model: 'https://cdn.glitch.global/6a86e926-284a-4a6c-83d3-e7de65893PA2/sports.glb', cost: 0 },
            truck: { name: 'Ø´Ø§Ø­Ù†Ø© Ø¨ÙŠÙƒ Ø£Ø¨', model: 'https://cdn.glitch.global/f8433a0a-1e66-4412-bd3b-4375a0af7483/pickup_cyber.glb', cost: 500 },
            classic: { name: 'Ø³ÙŠØ§Ø±Ø© ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©', model: 'https://cdn.glitch.global/f8433a0a-1e66-4412-bd3b-4375a0af7483/car_classic.glb', cost: 1500 }
        },
        wordStructure: {
            spelling: [ { en: 'house', ar: 'Ù…Ù†Ø²Ù„' }, { en: 'school', ar: 'Ù…Ø¯Ø±Ø³Ø©' }, { en: 'water', ar: 'Ù…Ø§Ø¡' }, { en: 'friend', ar: 'ØµØ¯ÙŠÙ‚' }, { en: 'apple', ar: 'ØªÙØ§Ø­Ø©' } ],
            fillInTheBlank: [ { q: 'h_use', a: 'o', en: 'house' }, { q: 'wat_r', a: 'e', en: 'water' }, { q: 'scho_l', a: 'o', en: 'school' }, { q: 'ap_le', a: 'p', en: 'apple' } ],
            plurals: [ { single: 'car', plural: 'cars' }, { single: 'book', plural: 'books' }, { single: 'boy', plural: 'boys' }, { single: 'girl', plural: 'girls' } ]
        },
        studyCorner: {
            pronouns: [ { en: 'I', ar: 'Ø£Ù†Ø§', example: 'I am a student.' }, { en: 'You', ar: 'Ø£Ù†Øª / Ø£Ù†ØªÙ…', example: 'You are my friend.' }, { en: 'He', ar: 'Ù‡Ùˆ', example: 'He is tall.' }, { en: 'She', ar: 'Ù‡ÙŠ', example: 'She is happy.' }, { en: 'It', ar: 'Ù‡Ùˆ / Ù‡ÙŠ (Ù„ØºÙŠØ± Ø§Ù„Ø¹Ø§Ù‚Ù„)', example: 'It is a big cat.' }, { en: 'We', ar: 'Ù†Ø­Ù†', example: 'We are a team.' }, { en: 'They', ar: 'Ù‡Ù… / Ù‡Ù†', example: 'They are playing.' } ],
            whQuestions: [ { en: 'What', ar: 'Ù…Ø§Ø°Ø§', example: 'What is this?' }, { en: 'Who', ar: 'Ù…Ù†', example: 'Who is that man?' }, { en: 'Where', ar: 'Ø£ÙŠÙ†', example: 'Where is the school?' }, { en: 'When', ar: 'Ù…ØªÙ‰', example: 'When is the party?' }, { en: 'Why', ar: 'Ù„Ù…Ø§Ø°Ø§', example: 'Why are you late?' }, { en: 'How', ar: 'ÙƒÙŠÙ', example: 'How are you?' } ],
            verbs: [ { en: 'go', ar: 'ÙŠØ°Ù‡Ø¨', example: 'I go to school.'}, { en: 'eat', ar: 'ÙŠØ£ÙƒÙ„', example: 'I eat an apple.'}, { en: 'see', ar: 'ÙŠØ±Ù‰', example: 'I see a bird.'}, { en: 'play', ar: 'ÙŠÙ„Ø¹Ø¨', example: 'They play football.'}, { en: 'read', ar: 'ÙŠÙ‚Ø±Ø£', example: 'She can read a book.'} ],
            adjectives: [ { en: 'big', ar: 'ÙƒØ¨ÙŠØ±', example: 'The elephant is big.'}, { en: 'small', ar: 'ØµØºÙŠØ±', example: 'The cat is small.'}, { en: 'happy', ar: 'Ø³Ø¹ÙŠØ¯', example: 'The boy is happy.'}, { en: 'sad', ar: 'Ø­Ø²ÙŠÙ†', example: 'The girl is sad.'}, { en: 'good', ar: 'Ø¬ÙŠØ¯', example: 'This is a good book.'} ],
            prepositions: [ { en: 'in', ar: 'ÙÙŠ', example: 'The cat is in the box.'}, { en: 'on', ar: 'Ø¹Ù„Ù‰', example: 'The book is on the table.'}, { en: 'under', ar: 'ØªØ­Øª', example: 'The ball is under the chair.'} ]
        },
        achievements: {
            level5: { id: 'level5', title: 'Ù…Ø¨ØªØ¯Ø¦ ÙˆØ§Ø¹Ø¯', desc: 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5', icon: 'ğŸŒ±', unlocked: false },
            level20: { id: 'level20', title: 'Ø·Ø§Ù„Ø¨ Ù…Ø¬ØªÙ‡Ø¯', desc: 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 20', icon: 'ğŸ§‘â€ğŸ“', unlocked: false },
            level50: { id: 'level50', title: 'Ø®Ø¨ÙŠØ± ØµØ§Ø¹Ø¯', desc: 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 50', icon: 'ğŸš€', unlocked: false },
            first1000: { id: 'first1000', title: 'Ù…Ù„ÙŠÙˆÙ†ÙŠØ± Ù†Ø§Ø´Ø¦', desc: 'Ø§Ø¬Ù…Ø¹ 1000 Ù‚Ø·Ø¹Ø© Ù†Ù‚Ø¯ÙŠØ©', icon: 'ğŸ’°', unlocked: false },
            allCars: { id: 'allCars', title: 'Ø¹Ø§Ø´Ù‚ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª', desc: 'Ø§Ù…ØªÙ„Ùƒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª', icon: 'ğŸš—', unlocked: false },
            firstCumulative: { id: 'firstCumulative', title: 'Ù…ÙØ®ØªØ¨ÙØ± Ù…ÙØ­Ù†ÙÙ‘Ùƒ', desc: 'Ø£ÙƒÙ…Ù„ Ø§Ø®ØªØ¨Ø§Ø±Ù‹Ø§ ØªØ±Ø§ÙƒÙ…ÙŠÙ‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§', icon: 'ğŸ§ ', unlocked: false }
        },
         dailyChallenges: [
            { id: 'complete3Levels', desc: 'Ø£ÙƒÙ…Ù„ 3 Ù…Ø³ØªÙˆÙŠØ§Øª', goal: 3, reward: 100, type: 'levels' },
            { id: 'quickTest10', desc: 'Ø£Ø­Ø±Ø² 10 Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹', goal: 10, reward: 75, type: 'quickTest' },
            { id: 'spell5Words', desc: 'Ø§ÙƒØªØ¨ 5 ÙƒÙ„Ù…Ø§Øª ØµØ­ÙŠØ­Ø©', goal: 5, reward: 50, type: 'spelling' }
        ]
    };
    
    // --- DOM ELEMENTS ---
    const DOM = {
        body: document.getElementById('body-container'), sidebar: document.getElementById('sidebar'), sidebarOverlay: document.getElementById('sidebar-overlay'), topBar: document.getElementById('top-bar'),
        screens: { 
            login: document.getElementById('login-screen'), 
            levelSelect: document.getElementById('level-select-screen'), 
            game: document.getElementById('game-screen'), 
            levelComplete: document.getElementById('level-complete-screen'), 
            garage: document.getElementById('garage-screen'), 
            quickTest: document.getElementById('quick-test-screen'), 
            cumulativeTest: document.getElementById('cumulative-test-screen'), 
            studyCorner: document.getElementById('study-corner-screen'), 
            achievements: document.getElementById('achievements-screen'), 
            speakingTest: document.getElementById('speaking-test-screen'), 
            matchingTest: document.getElementById('matching-test-screen'),
            stats: document.getElementById('stats-screen'),
            phraseBuilder: document.getElementById('phrase-builder-screen')
        },
        login: { nameInput: document.getElementById('player-name-input'), startBtn: document.getElementById('start-learning-btn'), googleBtn: document.getElementById('google-login-btn') },
        levelSelect: { greeting: document.getElementById('player-greeting'), path: document.getElementById('level-path'), profileInfo: document.getElementById('main-screen-profile-info'), dailyChallengeContainer: document.getElementById('daily-challenge-container') },
        game: { title: document.getElementById('level-title'), progressTracker: document.getElementById('level-progress-tracker'), questionText: document.getElementById('question-text'), questionIcon: document.getElementById('question-icon'), questionPrompt: document.getElementById('question-prompt'), answerArea: document.getElementById('answer-area'), feedback: document.getElementById('feedback'), checkBtn: document.getElementById('check-answer-btn'), repeatSpeechBtn: document.getElementById('repeat-speech-btn') },
        levelComplete: { message: document.getElementById('level-complete-message'), reward: document.getElementById('level-reward'), nextBtn: document.getElementById('next-level-btn') },
        garage: { carList: document.getElementById('garage-car-list') },
        sidebarItems: { 
            toggleBtn: document.getElementById('sidebar-toggle-btn'), 
            homeBtn: document.getElementById('home-btn-sidebar'), 
            studyCornerBtn: document.getElementById('study-corner-btn-sidebar'),
            achievementsBtn: document.getElementById('achievements-btn-sidebar'),
            statsBtn: document.getElementById('stats-btn-sidebar'),
            garageBtn: document.getElementById('garage-btn-sidebar'),
            startQuickTestBtn: document.getElementById('start-quick-test-btn-sidebar'),
            startCumulativeTestBtn: document.getElementById('start-cumulative-test-btn-sidebar'),
            speakingTestBtn: document.getElementById('speaking-test-btn-sidebar'),
            matchingTestBtn: document.getElementById('matching-test-btn-sidebar'),
            phraseBuilderBtn: document.getElementById('phrase-builder-btn-sidebar'),
            strictModeToggle: document.getElementById('strict-mode-checkbox'), 
            sfxToggle: document.getElementById('sfx-checkbox'), 
            ttsToggle: document.getElementById('tts-checkbox'),
            voiceSelect: document.getElementById('voice-select'),
            phraseBuilderModeToggle: document.getElementById('phrase-builder-mode-checkbox'),
        },
        playerStats: { coins: document.getElementById('player-coins'), avatar: document.getElementById('avatar-container') },
        quickTest: { gameArea: document.getElementById('quick-test-game-area'), finalScoreArea: document.getElementById('quick-test-final-score'), currentScore: document.getElementById('quick-test-current-score'), highScore: document.getElementById('quick-test-high-score'), questionArea: document.getElementById('quick-test-question-area'), answerArea: document.getElementById('quick-test-answer-area'), feedback: document.getElementById('quick-test-feedback'), checkBtn: document.getElementById('quick-test-check-btn'), finalScoreValue: document.getElementById('final-score-value'), newHighscoreMsg: document.getElementById('new-highscore-message'), retryBtn: document.getElementById('retry-quick-test-btn') },
        cumulativeTest: { gameArea: document.getElementById('cumulative-test-game-area'), finalScoreArea: document.getElementById('cumulative-test-final-score'), currentScore: document.getElementById('cumulative-test-current-score'), totalQuestions: document.getElementById('cumulative-test-total-questions'), questionArea: document.getElementById('cumulative-test-question-area'), answerArea: document.getElementById('cumulative-test-answer-area'), feedback: document.getElementById('cumulative-test-feedback'), checkBtn: document.getElementById('cumulative-test-check-btn'), finalScoreValue: document.getElementById('cumulative-final-score-value'), coinsReward: document.getElementById('cumulative-coins-reward'), retryBtn: document.getElementById('retry-cumulative-test-btn') },
        studyCorner: { content: document.getElementById('study-corner-content') },
        achievements: { content: document.getElementById('achievements-content') },
        stats: { content: document.getElementById('stats-content') },
        speakingTest: { questionText: document.getElementById('speaking-question-text'), listenBtn: document.getElementById('speaking-listen-btn'), micBtn: document.getElementById('mic-btn'), status: document.getElementById('speaking-status'), feedback: document.getElementById('speaking-feedback'), newChallengeBtn: document.getElementById('new-speaking-challenge-btn') },
        matchingTest: { score: document.getElementById('match-score'), enColumn: document.getElementById('matching-english-column'), arColumn: document.getElementById('matching-arabic-column'), nextBtn: document.getElementById('next-match-question-btn') },
        phraseBuilder: {
            instruction: document.getElementById('phrase-builder-instruction'),
            area: document.getElementById('phrase-builder-area'),
            question: document.getElementById('phrase-builder-question'),
            answerArea: document.getElementById('phrase-builder-answer-area'),
            wordBank: document.getElementById('phrase-builder-word-bank'),
            feedback: document.getElementById('phrase-builder-feedback'),
            checkBtn: document.getElementById('phrase-builder-check-btn'),
            clearBtn: document.getElementById('phrase-builder-clear-btn'),
            listenModeToggle: document.getElementById('phrase-listen-mode-checkbox'),
            hintBtn: document.getElementById('phrase-builder-hint-btn'),
        },
        backToMapButtons: document.querySelectorAll('.back-to-map-button')
    };

    let state = {};
    function getDefaultState() { 
        return { 
            playerName: '', 
            unlockedLevelIndex: 0, 
            currentLevelIndex: 0, 
            currentQuestion: null, 
            correctInLevel: 0, 
            lastLoginDate: null,
            streak: 0,
            lastQuestionKey: null, 
            coins: 0, 
            cars: { owned: ['sports'], equipped: 'sports' }, 
            sfxEnabled: true, 
            ttsEnabled: true, 
            voice: null,
            strictModeEnabled: false,
            phraseBuilderListenMode: false,
            phraseBuilderMode: 'click',
            quickTestHighScore: 0, 
            currentQuickTestScore: 0, 
            cumulativeTest: { questions: [], currentQuestionIndex: 0, score: 0 }, 
            achievements: { ...learningData.achievements }, 
            matchScore: 0,
            stats: {
                totalCorrect: 0,
                totalIncorrect: 0,
                spellingCorrect: 0,
                levelsCompletedToday: 0
            },
            dailyChallenge: {
                id: null,
                progress: 0,
                lastCompletedDate: null
            },
        }; 
    }

    let audioCtx;
    const soundSystem = { play: (type) => { if (!state.sfxEnabled) return; if (!audioCtx) { try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { console.error("Audio Context not supported"); return; } } const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.1, audioCtx.currentTime); if (type === 'correct') { o.type = 'sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.4); o.frequency.exponentialRampToValueAtTime(900, audioCtx.currentTime + 0.2); } else if (type === 'incorrect') { o.type = 'square'; o.frequency.setValueAtTime(150, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3); } else if (type === 'click') { o.type = 'triangle'; o.frequency.setValueAtTime(440, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1); } else if (type === 'levelComplete') { o.type = 'sine'; const now = audioCtx.currentTime; o.frequency.setValueAtTime(440, now); o.frequency.linearRampToValueAtTime(587.33, now + 0.1); o.frequency.linearRampToValueAtTime(880, now + 0.2); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.4); } else if (type === 'buy') { o.type = 'sawtooth'; o.frequency.setValueAtTime(200, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.3); o.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 0.2);} else if (type === 'flip') { o.type = 'sine'; o.frequency.setValueAtTime(300, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1); } else if (type === 'match') { o.type = 'sine'; o.frequency.setValueAtTime(800, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.2); o.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1); } else if (type === 'drop') { o.type = 'sine'; o.frequency.setValueAtTime(523.25, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15); } else if (type === 'return') { o.type = 'triangle'; o.frequency.setValueAtTime(300, audioCtx.currentTime); o.frequency.linearRampToValueAtTime(200, audioCtx.currentTime + 0.1); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.15); }
            o.start(); o.stop(audioCtx.currentTime + 0.5); }
    };
    
    let voices = [];
    const ttsSystem = { 
        loadVoices: () => {
            voices = window.speechSynthesis.getVoices().filter(v => v.lang.startsWith('en'));
            DOM.sidebarItems.voiceSelect.innerHTML = voices
                .map((voice, index) => `<option value="${index}">${voice.name} (${voice.lang})</option>`)
                .join('');
            if (state.voice && voices[state.voice]) {
                DOM.sidebarItems.voiceSelect.value = state.voice;
            }
        },
        speak: (text) => { 
            if (!state.ttsEnabled || !text) return; 
            window.speechSynthesis.cancel(); 
            const utterance = new SpeechSynthesisUtterance(text); 
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            if(state.voice && voices[state.voice]) {
                utterance.voice = voices[state.voice];
            }
            window.speechSynthesis.speak(utterance); 
        } 
    };
    window.app = { speak: ttsSystem.speak }; 

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if (SpeechRecognition) { recognition = new SpeechRecognition(); recognition.continuous = false; recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1; }

    function getLevelGenerator(levelIndex) { if (levelIndex < 15) return generateAlphabetQuestion('en-to-ar'); if (levelIndex < 30) return generateAlphabetQuestion('ar-to-en'); if (levelIndex < 50) return generateWordQuestion('animals'); if (levelIndex < 70) return generateWordQuestion('colors'); if (levelIndex < 85) return generateWordQuestion('numbers'); if (levelIndex < 100) return generateSentenceQuestion(); const type = Math.random(); if (type < 0.4) return generateSpellingQuestion(); if (type < 0.7) return generateFillInTheBlankQuestion(); return generatePluralQuestion(); }
    const generateUniqueQuestion = (bank, key) => { let item; do { item = bank[Math.floor(Math.random() * bank.length)]; } while (item && item[key] === state.lastQuestionKey); if (item) { state.lastQuestionKey = item[key]; } return item; };
    function generateAlphabetQuestion(direction) { const keys = Object.keys(learningData.alphabet); let randomKey; do { randomKey = keys[Math.floor(Math.random() * keys.length)]; } while (randomKey === state.lastQuestionKey); state.lastQuestionKey = randomKey; const arAnswers = learningData.alphabet[randomKey]; return { type: 'input', prompt: direction === 'en-to-ar' ? 'Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø­Ø±Ù:' : 'Ø§ÙƒØªØ¨ Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø¨Ù„:', questionText: direction === 'en-to-ar' ? randomKey : arAnswers[0], questionIcon: 'ğŸ”¤', answer: direction === 'en-to-ar' ? arAnswers : randomKey, speak: direction === 'en-to-ar' ? randomKey : null, questionCategory: 'alphabet' }; }
    function generateWordQuestion(category) { const word = generateUniqueQuestion(learningData.words[category], 'en'); return { type: 'input', prompt: `Ù…Ø§ Ù‡ÙŠ ØªØ±Ø¬Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©ØŸ`, questionText: word.en, questionIcon: word.icon, answer: [word.ar], speak: word.en, questionCategory: 'word' }; }
    function generateSentenceQuestion() { const sentence = generateUniqueQuestion(learningData.sentences, 'en'); const words = sentence.en.split(' '); const shuffledWords = [...words].sort(() => Math.random() - 0.5); return { type: 'scramble', prompt: 'Ø±ØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„ØªÙƒÙˆÙŠÙ† Ø¬Ù…Ù„Ø© ØµØ­ÙŠØ­Ø©:', questionText: sentence.ar, questionIcon: 'ğŸ“œ', shuffled: shuffledWords, answer: sentence.en, speak: sentence.en, questionCategory: 'sentence' }; }
    function generateSpellingQuestion() { const word = generateUniqueQuestion(learningData.wordStructure.spelling, 'en'); return { type: 'input', prompt: `Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„ØªÙŠ ØªØ¹Ù†ÙŠ "${word.ar}"`, questionText: 'âœï¸', questionIcon: '', answer: [word.en], speak: word.en, questionCategory: 'spelling' }; }
    function generateFillInTheBlankQuestion() { const word = generateUniqueQuestion(learningData.wordStructure.fillInTheBlank, 'en'); return { type: 'input', prompt: 'Ø§Ù…Ù„Ø£ Ø§Ù„ÙØ±Ø§Øº Ø¨Ø§Ù„Ø­Ø±Ù Ø§Ù„ØµØ­ÙŠØ­:', questionText: word.q, questionIcon: 'ğŸ¤”', answer: [word.a], speak: word.en, questionCategory: 'spelling' }; }
    function generatePluralQuestion() { const word = generateUniqueQuestion(learningData.wordStructure.plurals, 'single'); return { type: 'input', prompt: 'Ø§ÙƒØªØ¨ ØµÙŠØºØ© Ø§Ù„Ø¬Ù…Ø¹ Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:', questionText: word.single, questionIcon: 'ğŸ“š', answer: [word.plural], speak: word.single, questionCategory: 'spelling' }; }

    function startLevel(levelIndex) { soundSystem.play('click'); state.currentLevelIndex = levelIndex; state.correctInLevel = 0; DOM.game.title.textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${levelIndex + 1}`; updateProgressTracker(); generateQuestion(); switchScreen('game'); }
    function generateQuestion() { state.currentQuestion = getLevelGenerator(state.currentLevelIndex); const q = state.currentQuestion; DOM.game.questionText.textContent = q.questionText; DOM.game.questionIcon.textContent = q.questionIcon || ''; DOM.game.questionPrompt.textContent = q.prompt; DOM.game.feedback.textContent = ''; DOM.playerStats.avatar.className = ''; DOM.game.answerArea.innerHTML = ''; if (q.type === 'input') { const input = document.createElement('input'); input.type = 'text'; input.id = 'answer-input'; input.style = "font-size: 2rem; direction: ltr; text-align: center; width: 100%; max-width: 300px; padding: 10px; margin-top: 10px;"; input.autocomplete = 'off'; DOM.game.answerArea.appendChild(input); input.addEventListener('keyup', e => { if (e.key === 'Enter') DOM.game.checkBtn.click(); }); setTimeout(() => input.focus(), 100); } else if (q.type === 'scramble') { const sentenceAnswer = document.createElement('div'); sentenceAnswer.id = 'sentence-answer-area'; sentenceAnswer.style="min-height: 50px; border: 2px dashed var(--primary-color); border-radius: 10px; padding: 10px; margin-top: 10px; direction: ltr;"; const scrambleArea = document.createElement('div'); scrambleArea.style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap; justify-content: center;"; q.shuffled.forEach(word => { const chip = document.createElement('span'); chip.textContent = word; chip.style="padding: 10px 20px; background: var(--light-grey); border-radius: 20px; cursor: pointer; transition: 0.2s;"; chip.onmouseover=()=> {chip.style.backgroundColor= 'var(--secondary-color)'; chip.style.color='var(--white)'}; chip.onmouseout=()=> {chip.style.backgroundColor='var(--light-grey)'; chip.style.color='var(--dark-text)'}; chip.onclick = () => { sentenceAnswer.textContent += (sentenceAnswer.textContent ? ' ' : '') + word; chip.style.display = 'none'; }; scrambleArea.appendChild(chip); }); DOM.game.answerArea.appendChild(scrambleArea); DOM.game.answerArea.appendChild(sentenceAnswer); } DOM.game.checkBtn.disabled = false; ttsSystem.speak(q.speak); }
    function checkAnswer() { DOM.game.checkBtn.disabled = true; const q = state.currentQuestion; let userInput, isCorrect, answerInput; if (q.type === 'input') { answerInput = document.getElementById('answer-input'); userInput = answerInput.value.trim(); } else if (q.type === 'scramble') { answerInput = document.getElementById('sentence-answer-area'); userInput = answerInput.textContent.trim(); } if (!userInput) { DOM.game.checkBtn.disabled = false; return; } const normalizedUserInput = userInput.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').toLowerCase(); isCorrect = Array.isArray(q.answer) ? q.answer.some(ans => ans.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').toLowerCase() === normalizedUserInput) : q.answer.toLowerCase() === normalizedUserInput; answerInput.classList.add(isCorrect ? 'correct-input' : 'incorrect-input'); if (isCorrect) { soundSystem.play('correct'); DOM.playerStats.avatar.className = 'happy'; DOM.playerStats.avatar.textContent = 'ğŸ˜Š'; DOM.game.feedback.textContent = learningData.phrases.correct[Math.floor(Math.random() * learningData.phrases.correct.length)]; DOM.game.feedback.style.color = 'var(--correct-color)'; state.correctInLevel++; state.stats.totalCorrect++; if (q.questionCategory === 'spelling') { state.stats.spellingCorrect++; checkDailyChallengeProgress('spelling'); } updateProgressTracker(); setTimeout(() => { if (state.correctInLevel >= QUESTIONS_PER_LEVEL) { completeLevel(); } else { generateQuestion(); } }, 1500); } else { soundSystem.play('incorrect'); DOM.playerStats.avatar.className = 'sad'; DOM.playerStats.avatar.textContent = 'ğŸ˜Ÿ'; state.stats.totalIncorrect++; if(state.strictModeEnabled) { DOM.game.feedback.textContent = learningData.phrases.incorrect[Math.floor(Math.random() * learningData.phrases.incorrect.length)]; DOM.game.feedback.style.color = 'var(--incorrect-color)'; setTimeout(() => { answerInput.classList.remove('incorrect-input'); DOM.game.checkBtn.disabled = false; }, 1000); } else { const correctAnswerDisplay = Array.isArray(q.answer) ? q.answer.join(' Ø£Ùˆ ') : q.answer; DOM.game.feedback.innerHTML = `Ø®Ø·Ø£... Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: <strong style="color: var(--dark-text);">${correctAnswerDisplay}</strong>`; DOM.game.feedback.style.color = 'var(--incorrect-color)'; setTimeout(() => { if (state.correctInLevel >= QUESTIONS_PER_LEVEL) { completeLevel(); } else { generateQuestion(); } }, 2500); } } saveState(); }
    function completeLevel() { soundSystem.play('levelComplete'); DOM.playerStats.avatar.textContent = 'ğŸ‰'; const rewardAmount = 10 + Math.floor(state.currentLevelIndex / 5) * 5; addCoins(rewardAmount); DOM.levelComplete.reward.textContent = `+${rewardAmount} ğŸ’°`; if (state.currentLevelIndex === state.unlockedLevelIndex) { state.unlockedLevelIndex++; } state.stats.levelsCompletedToday++; checkDailyChallengeProgress('levels'); checkAllAchievements(); saveState(); updateUI(); DOM.levelComplete.message.textContent = `Ù„Ù‚Ø¯ Ø£ØªÙ‚Ù†Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${state.currentLevelIndex + 1}! Ø£Ù†Øª Ø¨Ø·Ù„ Ø­Ù‚ÙŠÙ‚ÙŠ!`; const isLastLevel = state.currentLevelIndex + 1 >= TOTAL_LEVELS; DOM.levelComplete.nextBtn.textContent = isLastLevel ? 'Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ù„Ø¹Ø¨Ø©!' : 'Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ'; DOM.levelComplete.nextBtn.disabled = isLastLevel; switchScreen('levelComplete'); }

    function startQuickTest() { soundSystem.play('click'); closeSidebar(); state.currentQuickTestScore = 0; DOM.quickTest.gameArea.style.display = 'block'; DOM.quickTest.finalScoreArea.style.display = 'none'; updateQuickTestUI(); generateQuickTestQuestion(); switchScreen('quickTest'); }
    function generateQuickTestQuestion() { let question; const score = state.currentQuickTestScore; if (score < 5) { question = Math.random() < 0.5 ? generateAlphabetQuestion('en-to-ar') : generateWordQuestion('animals'); } else if (score < 15) { question = Math.random() < 0.6 ? generateWordQuestion('colors') : generateSentenceQuestion(); } else { const type = Math.random(); if (type < 0.4) question = generateSpellingQuestion(); else if (type < 0.7) question = generateFillInTheBlankQuestion(); else question = generatePluralQuestion(); } state.currentQuestion = question; DOM.quickTest.questionArea.innerHTML = `<div style="display: flex; align-items: center; gap: 15px;"><div style="font-size: clamp(2.5rem, 12vw, 4rem); font-weight: 900; direction: ltr;">${question.questionText}</div><div style="font-size: 3.5rem;">${question.questionIcon || ''}</div></div><div style="font-size: 1.3rem; margin-top: 10px;">${question.prompt}</div>`; const input = document.createElement('input'); input.type = 'text'; input.id = 'quick-test-answer-input'; input.style = "font-size: 2rem; direction: ltr; text-align: center; width: 100%; max-width: 300px; padding: 10px; margin-top: 10px;"; input.autocomplete = 'off'; DOM.quickTest.answerArea.innerHTML = ''; DOM.quickTest.answerArea.appendChild(input); input.focus(); input.addEventListener('keyup', e => { if (e.key === 'Enter') DOM.quickTest.checkBtn.click(); }); DOM.quickTest.feedback.textContent = ''; ttsSystem.speak(question.speak); }
    function checkQuickTestAnswer() { const input = document.getElementById('quick-test-answer-input'); const userInput = input.value.trim(); if (!userInput) return; const q = state.currentQuestion; const normalizedUserInput = userInput.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').toLowerCase(); const isCorrect = Array.isArray(q.answer) ? q.answer.some(ans => ans.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').toLowerCase() === normalizedUserInput) : q.answer.toLowerCase() === normalizedUserInput; if (isCorrect) { soundSystem.play('correct'); state.currentQuickTestScore++; updateQuickTestUI(); DOM.quickTest.feedback.textContent = 'ØµØ­ÙŠØ­! Ø§Ù„ØªØ§Ù„ÙŠ...'; DOM.quickTest.feedback.style.color = 'var(--correct-color)'; setTimeout(generateQuickTestQuestion, 1000); } else { soundSystem.play('incorrect'); endQuickTest(); } }
    function endQuickTest() { DOM.quickTest.gameArea.style.display = 'none'; DOM.quickTest.finalScoreArea.style.display = 'block'; DOM.quickTest.finalScoreValue.textContent = state.currentQuickTestScore; checkDailyChallengeProgress('quickTest', state.currentQuickTestScore); if (state.currentQuickTestScore > state.quickTestHighScore) { state.quickTestHighScore = state.currentQuickTestScore; DOM.quickTest.newHighscoreMsg.textContent = 'ğŸ‰ Ù†ØªÙŠØ¬Ø© Ù‚ÙŠØ§Ø³ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©!'; saveState(); } else { DOM.quickTest.newHighscoreMsg.textContent = ''; } updateQuickTestUI(); }
    function updateQuickTestUI() { DOM.quickTest.currentScore.textContent = state.currentQuickTestScore; DOM.quickTest.highScore.textContent = state.quickTestHighScore; }
    
    const CUMULATIVE_TEST_LENGTH = 15;
    function startCumulativeTest() { soundSystem.play('click'); closeSidebar(); state.cumulativeTest.score = 0; state.cumulativeTest.currentQuestionIndex = 0; state.cumulativeTest.questions = []; for (let i = 0; i < CUMULATIVE_TEST_LENGTH; i++) { const randomUnlockedLevel = Math.floor(Math.random() * (state.unlockedLevelIndex + 1)); state.cumulativeTest.questions.push(getLevelGenerator(randomUnlockedLevel)); } DOM.cumulativeTest.gameArea.style.display = 'block'; DOM.cumulativeTest.finalScoreArea.style.display = 'none'; DOM.cumulativeTest.totalQuestions.textContent = CUMULATIVE_TEST_LENGTH; generateCumulativeQuestion(); switchScreen('cumulativeTest'); }
    function generateCumulativeQuestion() { if (state.cumulativeTest.currentQuestionIndex >= CUMULATIVE_TEST_LENGTH) { endCumulativeTest(); return; } const question = state.cumulativeTest.questions[state.cumulativeTest.currentQuestionIndex]; state.currentQuestion = question; updateCumulativeTestUI(); DOM.cumulativeTest.questionArea.innerHTML = `<div style="display: flex; align-items: center; gap: 15px;"><div style="font-size: clamp(2.5rem, 12vw, 4rem); font-weight: 900; direction: ltr;">${question.questionText}</div><div style="font-size: 3.5rem;">${question.questionIcon || ''}</div></div><div style="font-size: 1.3rem; margin-top: 10px;">${question.prompt}</div>`; const input = document.createElement('input'); input.type = 'text'; input.id = 'cumulative-test-answer-input'; input.style = "font-size: 2rem; direction: ltr; text-align: center; width: 100%; max-width: 300px; padding: 10px; margin-top: 10px;"; input.autocomplete = 'off'; DOM.cumulativeTest.answerArea.innerHTML = ''; DOM.cumulativeTest.answerArea.appendChild(input); input.focus(); input.addEventListener('keyup', e => { if (e.key === 'Enter') DOM.cumulativeTest.checkBtn.click(); }); DOM.cumulativeTest.feedback.textContent = ''; ttsSystem.speak(question.speak); }
    function checkCumulativeAnswer() { const input = document.getElementById('cumulative-test-answer-input'); const userInput = input.value.trim(); if (!userInput) return; const q = state.currentQuestion; const normalizedUserInput = userInput.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').toLowerCase(); const isCorrect = Array.isArray(q.answer) ? q.answer.some(ans => ans.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§').toLowerCase() === normalizedUserInput) : q.answer.toLowerCase() === normalizedUserInput; if (isCorrect) { soundSystem.play('correct'); state.cumulativeTest.score++; state.stats.totalCorrect++; DOM.cumulativeTest.feedback.textContent = 'ØµØ­ÙŠØ­! Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ...'; DOM.cumulativeTest.feedback.style.color = 'var(--correct-color)'; } else { soundSystem.play('incorrect'); state.stats.totalIncorrect++; const correctAnswerDisplay = Array.isArray(q.answer) ? q.answer.join(' Ø£Ùˆ ') : q.answer; DOM.cumulativeTest.feedback.innerHTML = `Ø®Ø·Ø£. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: <strong style="color: var(--dark-text);">${correctAnswerDisplay}</strong>`; DOM.cumulativeTest.feedback.style.color = 'var(--incorrect-color)'; } state.cumulativeTest.currentQuestionIndex++; DOM.cumulativeTest.checkBtn.disabled = true; setTimeout(() => { DOM.cumulativeTest.checkBtn.disabled = false; generateCumulativeQuestion(); }, 1800); saveState(); }
    function endCumulativeTest() { const finalScore = state.cumulativeTest.score; const reward = finalScore * 2; addCoins(reward); state.achievements.firstCumulative.unlocked = true; checkAllAchievements(); saveState(); updateUI(); DOM.cumulativeTest.gameArea.style.display = 'none'; DOM.cumulativeTest.finalScoreArea.style.display = 'block'; DOM.cumulativeTest.finalScoreValue.textContent = `${finalScore} / ${CUMULATIVE_TEST_LENGTH}`; DOM.cumulativeTest.coinsReward.textContent = `${reward}`; }
    function updateCumulativeTestUI() { DOM.cumulativeTest.currentScore.textContent = state.cumulativeTest.score; }

    function saveState() { try { localStorage.setItem(PLAYER_DATA_KEY, JSON.stringify(state)); } catch (e) { console.error("Failed to save state:", e); } }
    function loadState() { const data = JSON.parse(localStorage.getItem(PLAYER_DATA_KEY)); if (data && data.playerName) { const defaultState = getDefaultState(); state = { ...defaultState, ...data }; return true; } return false; }
    function switchScreen(screenId) { Object.values(DOM.screens).forEach(s => s.classList.remove('active')); if (DOM.screens[screenId]) { DOM.screens[screenId].classList.add('active'); } else { DOM.screens.levelSelect.classList.add('active'); } DOM.playerStats.avatar.textContent = 'ğŸ¤”'; DOM.playerStats.avatar.className = ''; if (screenId !== 'login') { DOM.topBar.style.display = 'flex'; } else { DOM.topBar.style.display = 'none'; } }
    function renderLevelPath() { DOM.levelSelect.greeting.textContent = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${state.playerName}!`; const path = DOM.levelSelect.path; path.innerHTML = ''; for (let i = 0; i < TOTAL_LEVELS; i++) { const node = document.createElement('div'); node.className = 'level-node'; let icon = 'ğŸ”’'; if (i < state.unlockedLevelIndex) { node.classList.add('completed'); icon = 'ğŸŒŸ'; } else if (i === state.unlockedLevelIndex) { node.classList.add('current'); icon = 'ğŸš€'; } else { node.classList.add('locked'); } node.innerHTML = `<div class="level-number">${i + 1}</div><div class="level-icon">${icon}</div>`; if (i <= state.unlockedLevelIndex) { node.onclick = () => startLevel(i); } path.appendChild(node); } }
    function updateUI() { 
        DOM.playerStats.coins.textContent = `ğŸ’° ${state.coins}`; 
        const streakText = state.streak > 1 ? `<span style="color: #f59e0b; font-weight: bold; margin-right: 10px;">ğŸ”¥ ${state.streak} Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©</span>` : '';
        DOM.levelSelect.profileInfo.innerHTML = `<h4>Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ ${streakText}</h4><p>Ø§Ù„Ø§Ø³Ù…: <strong>${state.playerName}</strong></p><p>Ø§Ù„Ø³ÙŠØ§Ø±Ø©: <strong>${learningData.cars[state.cars.equipped].name}</strong></p><p>Ø§Ù„Ù†Ù‚ÙˆØ¯: <strong style="color:var(--gold-color);">${state.coins} ğŸ’°</strong></p><p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>${state.unlockedLevelIndex + 1}</strong></p>`;
        DOM.sidebarItems.strictModeToggle.checked = state.strictModeEnabled; 
        DOM.sidebarItems.sfxToggle.checked = state.sfxEnabled; 
        DOM.sidebarItems.ttsToggle.checked = state.ttsEnabled;
        DOM.sidebarItems.phraseBuilderModeToggle.checked = state.phraseBuilderMode === 'drag';
        DOM.phraseBuilder.listenModeToggle.checked = state.phraseBuilderListenMode;
        updateDailyChallengeUI();
    }
    function updateProgressTracker() { DOM.game.progressTracker.innerHTML = ''; for (let i = 0; i < QUESTIONS_PER_LEVEL; i++) { const star = document.createElement('div'); star.textContent = 'â˜…'; star.className = 'star'; if (i < state.correctInLevel) { star.classList.add('filled'); } DOM.game.progressTracker.appendChild(star); } }
    function handleLogin() { 
        const name = DOM.login.nameInput.value.trim(); 
        if (name) { 
            state.playerName = name;
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 864e5).toDateString();
            if (state.lastLoginDate === yesterday) {
                state.streak++;
            } else if (state.lastLoginDate !== today) {
                state.streak = 1;
            }
            state.lastLoginDate = today;
            saveState(); updateUI(); renderLevelPath(); setupDailyChallenge(); switchScreen('levelSelect'); soundSystem.play('click'); 
        } 
    }

    function renderGarage() { 
        DOM.garage.carList.innerHTML = '';
        const posterSVG = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='64' height='64' fill='%23cccccc'%3E%3Cpath d='M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z' opacity='.3'%3E%3C/path%3E%3Cpath d='M12 4a8 8 0 0 0-8 8 1 1 0 0 0 2 0 6 6 0 1 1 6 6 1 1 0 0 0 0 2 8 8 0 0 0 8-8 1 1 0 0 0-2 0 6 6 0 1 1-6-6 1 1 0 0 0 0-2z'%3E%3CanimateTransform attributeName='transform' type='rotate' from='0 12 12' to='360 12 12' dur='1s' repeatCount='indefinite'/%3E%3C/path%3E%3C/svg%3E`;

        Object.keys(learningData.cars).forEach(key => {
            const car = learningData.cars[key];
            const isOwned = state.cars.owned.includes(key);
            const isEquipped = state.cars.equipped === key;
            const card = document.createElement('div');
            card.className = 'car-card';
            let buttonsHTML = isOwned ? (isEquipped ? `<button disabled>ØªÙ… ØªØ¬Ù‡ÙŠØ²Ù‡Ø§</button>` : `<button onclick="window.app.equipCar('${key}')">ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø©</button>`) : `<button onclick="window.app.buyCar('${key}')" ${state.coins < car.cost ? 'disabled' : ''}>Ø´Ø±Ø§Ø¡ (${car.cost} ğŸ’°)</button>`;
            card.innerHTML = `
                <model-viewer id="viewer-${key}" src="${car.model}" poster="${posterSVG}" preload camera-controls auto-rotate alt="${car.name}">
                    <div class="model-error" slot="error">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„.</div>
                </model-viewer>
                <h4>${car.name}</h4>
                <div class="price" style="font-weight: bold; color: var(--gold-color); font-size: 1.2rem;">${isOwned ? 'Ù…Ù…Ù„ÙˆÙƒØ©' : 'Ø§Ù„ØªÙƒÙ„ÙØ©: ' + car.cost + ' ğŸ’°'}</div>
                <div class="actions" style="margin-top:10px;">${buttonsHTML}</div>
            `;
            DOM.garage.carList.appendChild(card);
        });
    }
    function buyCar(carId) { const car = learningData.cars[carId]; if (state.coins >= car.cost && !state.cars.owned.includes(carId)) { state.coins -= car.cost; state.cars.owned.push(carId); soundSystem.play('buy'); checkAllAchievements(); saveState(); updateUI(); renderGarage(); } }
    function equipCar(carId) { if (state.cars.owned.includes(carId)) { state.cars.equipped = carId; soundSystem.play('click'); saveState(); updateUI(); renderGarage(); } }
    window.app.buyCar = buyCar; window.app.equipCar = equipCar;
    
    function addCoins(amount) {
        state.coins += amount;
        const coinCounter = DOM.playerStats.coins;
        const rect = coinCounter.getBoundingClientRect();
        for (let i = 0; i < Math.min(amount / 5, 10); i++) {
            const coin = document.createElement('div');
            coin.innerHTML = 'ğŸ’°';
            coin.className = 'coin-animation';
            document.body.appendChild(coin);
            coin.style.top = `${window.innerHeight / 2}px`;
            coin.style.left = `${window.innerWidth / 2}px`;
            setTimeout(() => {
                coin.style.top = `${rect.top}px`;
                coin.style.left = `${rect.left}px`;
                coin.style.transform = 'scale(0.5)';
                coin.style.opacity = '0';
            }, 100 + i * 50);
            setTimeout(() => coin.remove(), 1100 + i * 50);
        }
        checkAllAchievements();
        saveState();
        updateUI();
    }

    function renderStudyCorner() { const { alphabet, studyCorner, words, sentences } = learningData; let contentHTML = ''; const createSection = (title, items, type) => { let sectionHTML = `<div class="study-section"><h3>${title}</h3>`; if (type === 'grid') { sectionHTML += `<div class="study-grid">`; items.forEach(item => { sectionHTML += `<div class="study-item"><div class="en">${item.en || Object.keys(item)[0]} ${item.icon || ''}</div><div class="ar">${item.ar || Object.values(item)[0].join(' / ')}</div></div>`; }); sectionHTML += `</div>`; } else if (type === 'list-speak') { items.forEach(item => { sectionHTML += `<div class="generic-item"><div><div class="en">${item.en} - ${item.ar}</div><div class="example">${item.example}</div></div><button class="speak-btn" onclick="app.speak('${item.example}')">ğŸ”Š</button></div>`; }); } else if (type === 'vocab-speak') { sectionHTML += `<div class="study-grid">`; items.forEach(item => { sectionHTML += `<div class="study-item"><div class="en">${item.en} ${item.icon || ''}</div><div class="ar">${item.ar}</div><button class="speak-btn" onclick="app.speak('${item.en}')">ğŸ”Š</button></div>`; }); sectionHTML += `</div>`; } else if (type === 'sentence-speak') {  items.forEach(item => { sectionHTML += `<div class="generic-item"><div><div class="en">${item.en}</div><div class="ar">${item.ar}</div></div><button class="speak-btn" onclick="app.speak('${item.en}')">ğŸ”Š</button></div>`; }); } sectionHTML += `</div>`; return sectionHTML; }; contentHTML += createSection('Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ø£Ø¨Ø¬Ø¯ÙŠØ©', Object.entries(alphabet).map(([en, ar]) => ({en, ar})), 'grid'); contentHTML += createSection('Ø¶Ù…Ø§Ø¦Ø± Ø§Ù„ÙØ§Ø¹Ù„', studyCorner.pronouns, 'list-speak'); contentHTML += createSection('Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø§Ø³ØªÙÙ‡Ø§Ù…', studyCorner.whQuestions, 'list-speak'); contentHTML += createSection('Ø§Ù„Ø£ÙØ¹Ø§Ù„ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©', studyCorner.verbs, 'list-speak'); contentHTML += createSection('Ø§Ù„ØµÙØ§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©', studyCorner.adjectives, 'list-speak'); contentHTML += createSection('Ø­Ø±ÙˆÙ Ø§Ù„Ø¬Ø±', studyCorner.prepositions, 'list-speak'); Object.entries(words).forEach(([category, wordList]) => { const categoryName = {animals: 'Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª', colors: 'Ø§Ù„Ø£Ù„ÙˆØ§Ù†', numbers: 'Ø§Ù„Ø£Ø±Ù‚Ø§Ù…', food: 'Ø§Ù„Ø·Ø¹Ø§Ù…', family: 'Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©', body: 'Ø§Ù„Ø¬Ø³Ù…', nature: 'Ø§Ù„Ø·Ø¨ÙŠØ¹Ø©'}[category] || category; contentHTML += createSection(`Ø¨Ù†Ùƒ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: ${categoryName}`, wordList, 'vocab-speak'); }); contentHTML += createSection('Ø¨Ù†Ùƒ Ø§Ù„Ø¬Ù…Ù„', sentences, 'sentence-speak'); DOM.studyCorner.content.innerHTML = contentHTML; }

    function checkAllAchievements() { if (state.unlockedLevelIndex >= 5) state.achievements.level5.unlocked = true; if (state.unlockedLevelIndex >= 20) state.achievements.level20.unlocked = true; if (state.unlockedLevelIndex >= 50) state.achievements.level50.unlocked = true; if (state.coins >= 1000) state.achievements.first1000.unlocked = true; if (state.cars.owned.length === Object.keys(learningData.cars).length) state.achievements.allCars.unlocked = true; saveState(); }
    function renderAchievements() { DOM.achievements.content.innerHTML = ''; let gridHTML = '<div class="achievement-grid">'; Object.values(state.achievements).forEach(ach => { const statusClass = ach.unlocked ? 'unlocked' : 'locked'; gridHTML += `<div class="achievement-card ${statusClass}"><div class="achievement-icon">${ach.icon}</div><div class="achievement-title">${ach.title}</div><div class="achievement-desc">${ach.desc}</div></div>`; }); gridHTML += '</div>'; DOM.achievements.content.innerHTML = gridHTML; }
    
    function renderStats() { const { totalCorrect, totalIncorrect } = state.stats; const totalAnswers = totalCorrect + totalIncorrect; const accuracy = totalAnswers > 0 ? ((totalCorrect / totalAnswers) * 100).toFixed(1) : 0; DOM.stats.content.innerHTML = `<div class="stat-grid"><div class="stat-card"><div class="stat-value">${accuracy}%</div><div class="stat-label">Ø§Ù„Ø¯Ù‚Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</div></div><div class="stat-card"><div class="stat-value">${state.unlockedLevelIndex}</div><div class="stat-label">Ù…Ø³ØªÙˆÙ‰ Ù…ÙƒØªÙ…Ù„</div></div><div class="stat-card"><div class="stat-value">${state.quickTestHighScore}</div><div class="stat-label">Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© (Ø³Ø±ÙŠØ¹)</div></div><div class="stat-card"><div class="stat-value">${Object.keys(state.achievements).filter(k => state.achievements[k].unlocked).length}</div><div class="stat-label">Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ù…Ø­Ù‚Ù‚Ø©</div></div><div class="stat-card"><div class="stat-value">${totalCorrect}</div><div class="stat-label">Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©</div></div><div class="stat-card"><div class="stat-value">${totalIncorrect}</div><div class="stat-label">Ø¥Ø¬Ø§Ø¨Ø§Øª Ø®Ø§Ø·Ø¦Ø©</div></div></div>`; }

    let speakingQuestion = null;
    function startSpeakingTest() { if (!recognition) { alert('Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…. Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬ÙˆØ¬Ù„ ÙƒØ±ÙˆÙ….'); return; } closeSidebar(); generateSpeakingChallenge(); switchScreen('speakingTest'); }
    function generateSpeakingChallenge() { const type = Math.random(); if (type > 0.5) { const allWords = Object.values(learningData.words).flat(); speakingQuestion = generateUniqueQuestion(allWords, 'en'); } else { speakingQuestion = generateUniqueQuestion(learningData.sentences, 'en'); } DOM.speakingTest.questionText.textContent = speakingQuestion.en; DOM.speakingTest.feedback.textContent = ''; DOM.speakingTest.status.textContent = 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø¨Ø¯Ø¡'; DOM.speakingTest.micBtn.disabled = false; DOM.speakingTest.micBtn.classList.remove('recording'); }
    function handleMicClick() { soundSystem.play('click'); DOM.speakingTest.micBtn.disabled = true; DOM.speakingTest.micBtn.classList.add('recording'); DOM.speakingTest.status.textContent = '...ÙŠØªÙ… Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ø¢Ù†'; recognition.start(); }
    if(recognition) {
        recognition.onresult = (event) => { const spokenText = event.results[0][0].transcript.toLowerCase().trim().replace(/[.,?]/g, ''); const correctText = speakingQuestion.en.toLowerCase().trim().replace(/[.,?]/g, ''); DOM.speakingTest.status.textContent = `Ù„Ù‚Ø¯ Ù‚Ù„Øª: "${spokenText}"`; if (spokenText === correctText) { soundSystem.play('correct'); DOM.speakingTest.feedback.textContent = "Ù†Ø·Ù‚ Ù…Ø°Ù‡Ù„! ØµØ­ÙŠØ­!"; DOM.speakingTest.feedback.style.color = 'var(--correct-color)'; state.stats.totalCorrect++; } else { soundSystem.play('incorrect'); DOM.speakingTest.feedback.textContent = `Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰! Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ: ${correctText}`; DOM.speakingTest.feedback.style.color = 'var(--incorrect-color)'; state.stats.totalIncorrect++; } DOM.speakingTest.micBtn.classList.remove('recording'); DOM.speakingTest.micBtn.disabled = false; saveState(); };
        recognition.onerror = (event) => { DOM.speakingTest.status.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ùˆ Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØµÙˆØª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'; DOM.speakingTest.micBtn.classList.remove('recording'); DOM.speakingTest.micBtn.disabled = false; };
    }

    let matchingGameState = { selectedEn: null, selectedAr: null, matchedCount: 0 };
    function startMatchingTest() { closeSidebar(); state.matchScore = 0; DOM.matchingTest.score.textContent = state.matchScore; generateMatchingQuestion(); switchScreen('matchingTest'); }
    function generateMatchingQuestion() {
        DOM.matchingTest.enColumn.innerHTML = ''; DOM.matchingTest.arColumn.innerHTML = ''; DOM.matchingTest.nextBtn.style.display = 'none';
        matchingGameState = { selectedEn: null, selectedAr: null, matchedCount: 0 };
        const allWords = Object.values(learningData.words).flat();
        const shuffledWords = allWords.sort(() => 0.5 - Math.random());
        const currentWords = shuffledWords.slice(0, 4).map((word, index) => ({...word, id: index}));
        const isAudioQuestion = Math.random() < 0.25;
        const englishWords = [...currentWords].sort(() => 0.5 - Math.random());
        const arabicWords = [...currentWords].sort(() => 0.5 - Math.random());
        
        englishWords.forEach(word => {
            const enItem = document.createElement('div');
            enItem.classList.add('match-item');
            enItem.dataset.id = word.id;
            enItem.dataset.speak = word.en;
            if (isAudioQuestion) { enItem.innerHTML = 'ğŸ”Š'; enItem.classList.add('audio-item'); } else { enItem.textContent = word.en; }
            DOM.matchingTest.enColumn.appendChild(enItem);
            enItem.addEventListener('click', () => handleEnItemClick(enItem, word.id, word.en));
        });

        arabicWords.forEach(word => {
            const arItem = document.createElement('div');
            arItem.classList.add('match-item');
            arItem.dataset.id = word.id;
            arItem.textContent = word.ar;
            DOM.matchingTest.arColumn.appendChild(arItem);
            arItem.addEventListener('click', () => handleArItemClick(arItem, word.id));
        });
    }
    function handleEnItemClick(element, id, textToSpeak) { if(element.classList.contains('matched')) return; soundSystem.play('click'); ttsSystem.speak(textToSpeak); if (matchingGameState.selectedEn) { matchingGameState.selectedEn.element.classList.remove('selected'); } matchingGameState.selectedEn = { element, id }; element.classList.add('selected'); checkMatch(); }
    function handleArItemClick(element, id) { if(element.classList.contains('matched')) return; soundSystem.play('click'); if (matchingGameState.selectedAr) { matchingGameState.selectedAr.element.classList.remove('selected'); } matchingGameState.selectedAr = { element, id }; element.classList.add('selected'); checkMatch(); }
    function checkMatch() {
        if (!matchingGameState.selectedEn || !matchingGameState.selectedAr) return;
        const enEl = matchingGameState.selectedEn.element;
        const arEl = matchingGameState.selectedAr.element;
        if (matchingGameState.selectedEn.id === matchingGameState.selectedAr.id) { 
            soundSystem.play('match');
            enEl.classList.remove('selected'); arEl.classList.remove('selected');
            enEl.classList.add('matched'); arEl.classList.add('matched');
            matchingGameState.matchedCount++; state.matchScore++;
            DOM.matchingTest.score.textContent = state.matchScore;
            state.stats.totalCorrect++;
            const newEnEl = enEl.cloneNode(true); enEl.parentNode.replaceChild(newEnEl, enEl);
            const newArEl = arEl.cloneNode(true); arEl.parentNode.replaceChild(newArEl, arEl);
            if (matchingGameState.matchedCount === 4) { DOM.matchingTest.nextBtn.style.display = 'inline-flex'; }
        } else { 
            soundSystem.play('incorrect'); state.stats.totalIncorrect++;
            enEl.classList.add('incorrect-flash'); arEl.classList.add('incorrect-flash');
            setTimeout(() => { enEl.classList.remove('incorrect-flash', 'selected'); arEl.classList.remove('incorrect-flash', 'selected'); }, 500);
        }
        matchingGameState.selectedEn = null; matchingGameState.selectedAr = null; saveState();
    }

    function getTodayString() { return new Date().toDateString(); }
    function setupDailyChallenge() {
        const today = getTodayString();
        if (state.dailyChallenge.lastCompletedDate !== today) {
            const challengeIndex = new Date().getDate() % learningData.dailyChallenges.length;
            state.dailyChallenge.id = learningData.dailyChallenges[challengeIndex].id;
            state.dailyChallenge.progress = 0;
            state.stats.levelsCompletedToday = 0;
            state.stats.spellingCorrect = 0;
        }
        updateDailyChallengeUI();
    }
    function updateDailyChallengeUI() {
        const today = getTodayString();
        const challengeInfo = learningData.dailyChallenges.find(c => c.id === state.dailyChallenge.id);
        if (!challengeInfo || state.dailyChallenge.lastCompletedDate === today) {
            DOM.levelSelect.dailyChallengeContainer.innerHTML = `<h3>Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3><p>Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­! Ø¹Ø¯ ØºØ¯Ù‹Ø§ Ù„ØªØ­Ø¯Ù Ø¬Ø¯ÙŠØ¯. ğŸ‰</p>`;
            return;
        }
        let progress = 0;
        if (challengeInfo.type === 'levels') progress = state.stats.levelsCompletedToday;
        else if (challengeInfo.type === 'quickTest') progress = state.dailyChallenge.progress;
        else if (challengeInfo.type === 'spelling') progress = state.stats.spellingCorrect;
        
        const percentage = Math.min((progress / challengeInfo.goal) * 100, 100);
        
        DOM.levelSelect.dailyChallengeContainer.innerHTML = `<h3>Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3><p>${challengeInfo.desc}</p><p><strong>${progress} / ${challengeInfo.goal}</strong></p><div id="daily-challenge-progress-bar-container"><div id="daily-challenge-progress-bar" style="width: ${percentage}%;"></div></div><p style="font-size: 0.9rem; margin-top: 5px;">Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©: ${challengeInfo.reward} ğŸ’°</p>`;
    }
    function checkDailyChallengeProgress(type, value = 1) {
        const today = getTodayString();
        if (state.dailyChallenge.lastCompletedDate === today) return;
        const challengeInfo = learningData.dailyChallenges.find(c => c.id === state.dailyChallenge.id);
        if (!challengeInfo || challengeInfo.type !== type) return;
        let progressMade = false;
        if (type === 'levels' || type === 'spelling') { progressMade = true;
        } else if (type === 'quickTest') { if (value > state.dailyChallenge.progress) { state.dailyChallenge.progress = value; progressMade = true; } }
        if (progressMade) { const currentProgress = type === 'levels' ? state.stats.levelsCompletedToday : (type === 'spelling' ? state.stats.spellingCorrect : state.dailyChallenge.progress); if (currentProgress >= challengeInfo.goal) { state.dailyChallenge.lastCompletedDate = today; addCoins(challengeInfo.reward); alert(`ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ ${challengeInfo.reward} Ù‚Ø·Ø¹Ø© Ù†Ù‚Ø¯ÙŠØ©!`); } saveState(); updateDailyChallengeUI(); }
    }

    // --- PHRASE BUILDER LOGIC (DUAL MODE: CLICK/DRAG) ---
    let phraseBuilderState = { currentPhrase: null };
    let draggedElement = null;

    function startPhraseBuilder() { closeSidebar(); generatePhraseBuilderQuestion(); switchScreen('phraseBuilder'); }
    function generatePhraseBuilderQuestion() {
        phraseBuilderState.currentPhrase = generateUniqueQuestion(learningData.sentences, 'en');
        const phrase = phraseBuilderState.currentPhrase;
        const correctWords = phrase.en.replace(/[.,?]/g, '').split(' ');
        const allWords = Object.values(learningData.words).flat().map(w => w.en);
        let distractors = [];
        while (distractors.length < 3) {
            const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
            if (!correctWords.includes(randomWord) && !distractors.includes(randomWord)) distractors.push(randomWord);
        }
        const wordBankWords = [...correctWords, ...distractors].sort(() => 0.5 - Math.random());
        
        DOM.phraseBuilder.wordBank.innerHTML = '';
        DOM.phraseBuilder.answerArea.innerHTML = '';

        wordBankWords.forEach(word => {
            const chip = document.createElement('span');
            chip.className = 'word-chip';
            chip.textContent = word;
            DOM.phraseBuilder.wordBank.appendChild(chip);
        });
        
        setupPhraseBuilderInteractions();
        
        if (state.phraseBuilderListenMode) {
            DOM.phraseBuilder.question.style.display = 'none';
            DOM.phraseBuilder.hintBtn.style.display = 'inline-flex';
            ttsSystem.speak(phrase.en);
        } else {
            DOM.phraseBuilder.question.style.display = 'block';
            DOM.phraseBuilder.question.textContent = `ØªØ±Ø¬Ù…: "${phrase.ar}"`;
            DOM.phraseBuilder.hintBtn.style.display = 'none';
        }

        DOM.phraseBuilder.feedback.textContent = '';
        DOM.phraseBuilder.feedback.className = '';
    }
    
    function setupPhraseBuilderInteractions() {
        const isDragMode = state.phraseBuilderMode === 'drag';
        DOM.phraseBuilder.instruction.textContent = isDragMode ? "Ø§Ø³Ø­Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©." : "Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø¬Ù…Ù„Ø©.";

        document.querySelectorAll('#phrase-builder-area .word-chip').forEach(chip => {
            const newChip = chip.cloneNode(true);
            chip.parentNode.replaceChild(newChip, chip);
            
            if (isDragMode) {
                newChip.draggable = true;
            } else {
                newChip.draggable = false;
                newChip.addEventListener('click', handleWordChipClick);
            }
        });
    }
    
    function handleWordChipClick(event) {
        const chip = event.currentTarget;
        const fromBank = chip.parentElement.id === 'phrase-builder-word-bank';
        soundSystem.play('click');
        if (fromBank) {
            DOM.phraseBuilder.answerArea.appendChild(chip);
        } else {
            DOM.phraseBuilder.wordBank.appendChild(chip);
        }
    }

    function clearPhraseBuilder() {
        if (DOM.phraseBuilder.answerArea.children.length > 0) {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø¥Ø¬Ø§Ø¨ØªÙƒØŸ")) return;
        } else { return; }
        
        soundSystem.play('return');
        const answerChips = [...DOM.phraseBuilder.answerArea.querySelectorAll('.word-chip')];
        answerChips.forEach(chip => DOM.phraseBuilder.wordBank.appendChild(chip));
        DOM.phraseBuilder.feedback.textContent = '';
        DOM.phraseBuilder.feedback.className = '';
    }
    
    function checkPhraseBuilderAnswer() {
        const answerChips = [...DOM.phraseBuilder.answerArea.querySelectorAll('.word-chip')];
        if (answerChips.length === 0) return;
        const userAnswer = answerChips.map(chip => chip.textContent).join(' ');
        const correctAnswer = phraseBuilderState.currentPhrase.en.replace(/[.,?]/g, '');
        DOM.phraseBuilder.feedback.className = '';
        if (userAnswer.toLowerCase() === correctAnswer.toLowerCase()) {
            soundSystem.play('correct');
            DOM.phraseBuilder.feedback.textContent = 'Ø¬Ù…Ù„Ø© Ù…Ù…ØªØ§Ø²Ø©! ØµØ­ÙŠØ­Ø©!';
            DOM.phraseBuilder.feedback.style.color = 'var(--correct-color)';
            DOM.phraseBuilder.feedback.classList.add('correct-feedback');
            answerChips.forEach((chip, i) => setTimeout(() => chip.classList.add('correct-flash'), i * 100));
            state.stats.totalCorrect++;
            setTimeout(generatePhraseBuilderQuestion, 2000);
        } else {
            soundSystem.play('incorrect');
            DOM.phraseBuilder.feedback.innerHTML = `Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.`;
            DOM.phraseBuilder.feedback.style.color = 'var(--incorrect-color)';
            DOM.phraseBuilder.feedback.classList.add('incorrect-feedback');
            state.stats.totalIncorrect++;
        }
        saveState();
    }
    
    function getDragAfterElement(container, x) { const draggableElements = [...container.querySelectorAll('.word-chip:not(.dragging)')]; return draggableElements.reduce((closest, child) => { const box = child.getBoundingClientRect(); const offset = x - box.left - box.width / 2; if (offset < 0 && offset > closest.offset) { return { offset: offset, element: child }; } else { return closest; } }, { offset: Number.NEGATIVE_INFINITY }).element; }
    function handleDragStart(e) { if(state.phraseBuilderMode !== 'drag') return; draggedElement = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); }
    function handleDragEnd(e) { if(state.phraseBuilderMode !== 'drag') return; e.target.classList.remove('dragging'); draggedElement = null; }
    function handleDragOver(e) { if(state.phraseBuilderMode !== 'drag') return; e.preventDefault(); const container = e.currentTarget; const afterElement = getDragAfterElement(container, e.clientX); if (draggedElement) { if (afterElement == null) { container.appendChild(draggedElement); } else { container.insertBefore(draggedElement, afterElement); } } }
    function handleDrop(e) { if(state.phraseBuilderMode !== 'drag') return; e.preventDefault(); e.currentTarget.classList.remove('drag-over'); if (e.currentTarget.id === 'phrase-builder-answer-area') { soundSystem.play('drop'); } else { soundSystem.play('return'); } }
    
    const dropZones = [DOM.phraseBuilder.answerArea, DOM.phraseBuilder.wordBank];
    dropZones.forEach(container => { container.addEventListener('dragover', handleDragOver); container.addEventListener('dragenter', (e) => { if(state.phraseBuilderMode === 'drag') e.currentTarget.classList.add('drag-over')}); container.addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over')); container.addEventListener('drop', handleDrop); });
    DOM.phraseBuilder.area.addEventListener('dragstart', handleDragStart);
    DOM.phraseBuilder.area.addEventListener('dragend', handleDragEnd);

    // --- EVENT LISTENER HELPERS ---
    function addSafeListener(element, event, handler) { if (element) { element.addEventListener(event, handler); } else { console.error(`Failed to add listener for ${event} on a null element.`); } }
    function addClickAndTouchListener(element, handler) {
        if (!element) { console.error(`Failed to add listener to a null element.`); return; }
        const action = (e) => {
            e.preventDefault();
            handler(e);
        };
        element.addEventListener('touchend', action);
        element.addEventListener('click', action);
    }
    
    function closeSidebar() { DOM.body.classList.remove('sidebar-open'); }
    
    function init() {
        if (!loadState()) { state = getDefaultState(); }
        updateUI();
        
        ttsSystem.loadVoices();
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = ttsSystem.loadVoices;
        }

        if(state.playerName){ renderLevelPath(); setupDailyChallenge(); switchScreen('levelSelect'); }
        else { switchScreen('login'); }

        // --- Event Listeners ---
        addSafeListener(DOM.login.startBtn, 'click', handleLogin);
        addSafeListener(DOM.login.nameInput, 'keyup', e => { if (e.key === 'Enter') handleLogin() });
        addSafeListener(DOM.login.googleBtn, 'click', () => { DOM.login.nameInput.value = "Ø§Ù„Ù…ØºØ§Ù…Ø± Ø§Ù„Ø±Ø§Ø¦Ø¹"; handleLogin(); });
        
        addSafeListener(DOM.game.checkBtn, 'click', checkAnswer);
        addSafeListener(DOM.game.repeatSpeechBtn, 'click', () => { if (state.currentQuestion && state.currentQuestion.speak) ttsSystem.speak(state.currentQuestion.speak); });
        addSafeListener(DOM.levelComplete.nextBtn, 'click', () => { if (state.currentLevelIndex + 1 < TOTAL_LEVELS) { startLevel(state.currentLevelIndex + 1); } });
        
        addClickAndTouchListener(DOM.sidebarItems.toggleBtn, () => DOM.body.classList.toggle('sidebar-open'));
        addClickAndTouchListener(DOM.sidebarOverlay, closeSidebar);
        
        DOM.backToMapButtons.forEach(btn => addClickAndTouchListener(btn, () => { closeSidebar(); renderLevelPath(); switchScreen('levelSelect'); }));
        
        addClickAndTouchListener(DOM.sidebarItems.homeBtn, () => { closeSidebar(); renderLevelPath(); switchScreen('levelSelect'); });
        addClickAndTouchListener(DOM.sidebarItems.garageBtn, () => { closeSidebar(); renderGarage(); switchScreen('garage'); });
        addClickAndTouchListener(DOM.sidebarItems.studyCornerBtn, () => { closeSidebar(); renderStudyCorner(); switchScreen('studyCorner'); });
        addClickAndTouchListener(DOM.sidebarItems.achievementsBtn, () => { closeSidebar(); renderAchievements(); switchScreen('achievements'); });
        addClickAndTouchListener(DOM.sidebarItems.statsBtn, () => { closeSidebar(); renderStats(); switchScreen('stats'); });
        addClickAndTouchListener(DOM.sidebarItems.speakingTestBtn, startSpeakingTest);
        addClickAndTouchListener(DOM.sidebarItems.matchingTestBtn, startMatchingTest);
        addClickAndTouchListener(DOM.sidebarItems.phraseBuilderBtn, startPhraseBuilder);
        addClickAndTouchListener(DOM.sidebarItems.startQuickTestBtn, startQuickTest);
        addClickAndTouchListener(DOM.sidebarItems.startCumulativeTestBtn, startCumulativeTest);

        addSafeListener(DOM.sidebarItems.strictModeToggle, 'change', (e) => { state.strictModeEnabled = e.target.checked; saveState(); soundSystem.play('click'); });
        addSafeListener(DOM.sidebarItems.sfxToggle, 'change', (e) => { state.sfxEnabled = e.target.checked; saveState(); if(e.target.checked) soundSystem.play('click'); });
        addSafeListener(DOM.sidebarItems.ttsToggle, 'change', (e) => { state.ttsEnabled = e.target.checked; saveState(); soundSystem.play('click'); });
        addSafeListener(DOM.sidebarItems.voiceSelect, 'change', (e) => { state.voice = e.target.value; saveState(); soundSystem.play('click'); ttsSystem.speak("New voice selected"); });
        addSafeListener(DOM.sidebarItems.phraseBuilderModeToggle, 'change', (e) => { state.phraseBuilderMode = e.target.checked ? 'drag' : 'click'; saveState(); soundSystem.play('click'); if(DOM.screens.phraseBuilder.classList.contains('active')) { setupPhraseBuilderInteractions();} });

        addSafeListener(DOM.quickTest.checkBtn, 'click', checkQuickTestAnswer);
        addSafeListener(DOM.quickTest.retryBtn, 'click', startQuickTest);
        addSafeListener(DOM.cumulativeTest.checkBtn, 'click', checkCumulativeAnswer);
        addSafeListener(DOM.cumulativeTest.retryBtn, 'click', startCumulativeTest);
        
        addSafeListener(DOM.speakingTest.micBtn, 'click', handleMicClick);
        addSafeListener(DOM.speakingTest.listenBtn, 'click', () => { if(speakingQuestion) ttsSystem.speak(speakingQuestion.en); });
        addSafeListener(DOM.speakingTest.newChallengeBtn, 'click', generateSpeakingChallenge);
        
        addSafeListener(DOM.matchingTest.nextBtn, 'click', generateMatchingQuestion);

        addSafeListener(DOM.phraseBuilder.checkBtn, 'click', checkPhraseBuilderAnswer);
        addSafeListener(DOM.phraseBuilder.clearBtn, 'click', clearPhraseBuilder);
        addSafeListener(DOM.phraseBuilder.listenModeToggle, 'change', e => { state.phraseBuilderListenMode = e.target.checked; saveState(); generatePhraseBuilderQuestion(); });
        addSafeListener(DOM.phraseBuilder.hintBtn, 'click', () => { if (phraseBuilderState.currentPhrase) { DOM.phraseBuilder.question.textContent = `ØªØ±Ø¬Ù…: "${phraseBuilderState.currentPhrase.ar}"`; DOM.phraseBuilder.question.style.display = 'block'; DOM.phraseBuilder.hintBtn.style.display = 'none'; } });
    }

    init();
});
</script>
</body>
</html>
